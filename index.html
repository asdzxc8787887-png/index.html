<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成本計算器 (Firebase 連線)</title>
    
    <!-- PWA / App 相關 Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#171717">

    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Inter 字體 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Lucide Icons for a professional look -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* 定義黑金配色 */
        :root {
            --color-dark-bg: #111827; /* 接近黑色的深灰 */
            --color-card-bg: #1f2937; /* 稍亮的深灰 */
            --color-gold-accent: #f59e0b; /* 琥珀金/深黃 */
            --color-light-text: #f3f4f6; /* 淺色文字 */
            --color-medium-text: #9ca3af; /* 中等灰度文字 */
        }

        .bg-dark-bg { background-color: var(--color-dark-bg); }
        .bg-card-bg { background-color: var(--color-card-bg); }
        .text-gold { color: var(--color-gold-accent); }
        .border-gold { border-color: var(--color-gold-accent); }
        .ring-gold:focus { --tw-ring-color: var(--color-gold-accent); }
        
        /* 針對輸入框和下拉選單的暗色主題樣式 */
        .dark-input {
            background-color: #374151; /* 輸入框背景 */
            color: var(--color-light-text);
            border-color: #4b5563;
        }
        .dark-input:focus {
            border-color: var(--color-gold-accent);
        }

        /* 自定義滾動條以配合暗色主題 */
        .scrollable-list::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-list::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .scrollable-list::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        .scrollable-list::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>

    <script>
        window.__app_id = 'dessert-d852c';
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyAA65eP2I7mGMKpPP9wHAzVv14pG_BZ96g",
            authDomain: "dessert-d852c.firebaseapp.com",
            projectId: "dessert-d852c",
            storageBucket: "dessert-d852c.firebasestorage.app",
            messagingSenderId: "753350259966",
            appId: "1:753350259966:web:d419ac0e6796294db421af",
            measurementId: "G-MZN2NXWHMV"
        });
        window.__initial_auth_token = null;
    </script>

    <!-- 引入 Firebase SDK (重要：為了實現雲端協作) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch, arrayUnion, arrayRemove, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 啟用 Firebase 偵錯日誌
        setLogLevel('Debug');

        // --- 預定義單位清單 (新增) ---
        const PRICE_UNITS = ['袋', '箱', '桶', '件', '個', '批', 'kg', 'g', 'L', 'ml', '瓶', '盒'];
        const COST_UNITS = ['g', 'ml', '個', '片', '茶匙', '湯匙', 'oz', 'lb', '單位'];
        const YIELD_UNITS = ['份', '條', '個', '塊', 'L', 'kg', '批', '杯', '盤'];


        // --- Firebase 初始化與全域變數 ---
        // 取得環境變數
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let materials = {}; // 儲存所有原物料，方便查找
        let recipes = []; // 儲存所有食譜
        let isAuthReady = false;

        // 集合路徑建構器 (使用公共路徑實現協作)
        const getCollectionPath = (collectionName, isPublic = true) => {
            if (isPublic) {
                // 公共路徑 (所有使用者共享)
                return `artifacts/${appId}/public/data/${collectionName}`;
            } else {
                // 私人路徑 (未用到，但保留結構)
                return `artifacts/${appId}/users/${userId}/${collectionName}`;
            }
        };

        // --- 主要應用邏輯 ---

        /**
         * 填充下拉選單選項 (新函數)
         */
        const populateUnitSelectors = () => {
            const fillSelect = (selectId, units, defaultValue) => {
                const selectElement = document.getElementById(selectId);
                if (selectElement) {
                    selectElement.innerHTML = '';
                    let hasDefault = false;

                    units.forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit;
                        option.textContent = unit;
                        if (unit === defaultValue) {
                            option.selected = true;
                            hasDefault = true;
                        }
                        selectElement.appendChild(option);
                    });
                    
                    // 如果沒有預設值，則選中第一個選項
                    if (!hasDefault && units.length > 0) {
                         selectElement.value = units[0];
                    }
                }
            };
            
            // 原物料表單
            fillSelect('material-price-unit', PRICE_UNITS, '袋');
            fillSelect('material-cost-unit', COST_UNITS, 'g');
            
            // 食譜表單
            fillSelect('recipe-yield-unit', YIELD_UNITS, '份');
        };


        /**
         * 初始化 Firebase 並進行身份驗證
         */
        const initializeFirebase = async () => {
            // 在初始化 Firebase 前先填充單位，確保表單在頁面載入時就準備好
            populateUnitSelectors(); 

            try {
                if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    // 設置持久化 (可選，但推薦用於協作應用)
                    await setPersistence(auth, browserSessionPersistence);
                    
                    // 監聽身份驗證狀態 - 這是啟動 Firestore 實時監聽的關鍵
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            // 如果沒有用戶，則匿名登入
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                            } else {
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid; // 匿名用戶也有 uid
                            }
                        }
                        isAuthReady = true;
                        document.getElementById('user-id-display').textContent = userId;
                        startRealtimeListeners();
                        console.log("Firebase Auth Ready. User ID:", userId);
                    });
                } else {
                    // 離線模擬模式
                    console.error("Firebase Configuration is missing or empty. Running in offline mode.");
                    userId = 'offline-user-' + crypto.randomUUID().substring(0, 8);
                    isAuthReady = true;
                    document.getElementById('user-id-display').textContent = '離線模式 / ' + userId;
                    startRealtimeListeners(); 
                }
            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                userId = 'error-user-' + crypto.randomUUID().substring(0, 8);
                isAuthReady = true;
                document.getElementById('user-id-display').textContent = '錯誤模式 / ' + userId;
                startRealtimeListeners();
            }
        };

        // --- 核心：實時資料監聽 (Realtime Listeners) ---

        /**
         * 啟動 Firestore 實時監聽器 (確保數據即時同步的核心)
         */
        const startRealtimeListeners = () => {
            if (!db || !isAuthReady) return;

            // 監聽原物料清單 (Materials) - 任何新增、修改、刪除都會即時更新
            const materialsRef = collection(db, getCollectionPath('materials', true));
            onSnapshot(materialsRef, (snapshot) => {
                materials = {};
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    materials[doc.id] = { id: doc.id, ...data };
                });
                renderMaterialList();
                updateCalculatedCostDisplay(); // 確保成本顯示更新
                updateRecipeIngredientSelectors(); // 更新食譜中的下拉選單
                renderRecipeList(); // 重新計算所有食譜成本
                console.log("Materials updated in real-time:", Object.keys(materials).length, "items.");
            }, (error) => {
                console.error("監聽原物料失敗:", error);
            });

            // 監聽食譜清單 (Recipes) - 任何新增、修改、刪除都會即時更新
            const recipesRef = collection(db, getCollectionPath('recipes', true));
            onSnapshot(recipesRef, (snapshot) => {
                recipes = [];
                snapshot.forEach((doc) => {
                    recipes.push({ id: doc.id, ...doc.data() });
                });
                renderRecipeList();
                console.log("Recipes updated in real-time:", recipes.length, "recipes.");
            }, (error) => {
                console.error("監聽食譜失敗:", error);
            });
        };

        // 以下為原物料和食譜的渲染、計算和 CRUD 函數，保持不變，因為它們是連接到上面定義的 Firebase 函數。

        /**
         * 渲染原物料清單
         */
        const renderMaterialList = () => {
            const container = document.getElementById('material-list-container');
            container.innerHTML = '';
            
            const materialArray = Object.values(materials).sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));

            if (materialArray.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">目前沒有原物料，請新增。</p>';
                return;
            }

            materialArray.forEach(material => {
                // 計算每單位成本
                const costPerUnit = calculateCostPerUnit(material);
                const costDisplay = isNaN(costPerUnit) ? 'N/A' : costPerUnit.toFixed(2) + ' 元';
                const yieldRate = material.yield || 100;
                
                const card = document.createElement('div');
                card.className = 'bg-card-bg p-4 rounded-xl shadow-lg border border-gray-700 flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-2 sm:space-y-0';
                card.innerHTML = `
                    <div class="flex-grow w-full">
                        <h3 class="font-semibold text-lg text-gold">${material.name}</h3>
                        <p class="text-sm text-gray-400">
                            規格: ${material.spec || 0} / ${material.priceUnit || '單位'} | 
                            單價: $${material.price || 0} 
                        </p>
                        <p class="text-sm text-gray-400">
                            淨料率: ${yieldRate}% | 
                            成本單位: ${material.costUnit || 'g'}
                        </p>
                        <p class="mt-1 font-bold text-base text-green-500">
                            單次使用成本: ${costDisplay}
                        </p>
                    </div>
                    <div class="flex space-x-2 mt-2 sm:mt-0">
                        <button class="text-amber-400 hover:text-amber-200 p-2 rounded-full hover:bg-gray-700 transition" data-id="${material.id}" data-action="edit">
                            <i data-lucide="pencil" class="w-5 h-5" data-id="${material.id}" data-action="edit"></i>
                        </button>
                        <button class="text-red-500 hover:text-red-400 p-2 rounded-full hover:bg-gray-700 transition" data-id="${material.id}" data-action="delete">
                            <i data-lucide="trash-2" class="w-5 h-5" data-id="${material.id}" data-action="delete"></i>
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
            // 重新渲染 Lucide 圖標
            lucide.createIcons();
        };
        
        /**
         * 計算單一原物料的每單位成本
         */
        const calculateCostPerUnit = (material) => {
            const price = parseFloat(material.price) || 0;
            const spec = parseFloat(material.spec) || 0;
            const yieldRate = parseFloat(material.yield) / 100 || 1;
            
            if (price <= 0 || spec <= 0) return NaN;

            // 成本 = (價格 / 規格) / 淨料率
            const cost = (price / spec) / yieldRate;
            return cost;
        };

        /**
         * 更新原物料表單下方計算出的成本顯示
         */
        const updateCalculatedCostDisplay = () => {
            const nameInput = document.getElementById('material-name');
            const priceInput = document.getElementById('material-price');
            const specInput = document.getElementById('material-spec');
            // 注意：這裡直接讀取 select 的值
            const costUnitInput = document.getElementById('material-cost-unit');
            const yieldInput = document.getElementById('material-yield');

            // 檢查元素是否存在，避免在其他 tab 時報錯
            if (!nameInput || !priceInput || !specInput) return;

            const name = nameInput.value;
            const price = parseFloat(priceInput.value) || 0;
            const spec = parseFloat(specInput.value) || 0;
            const costUnit = costUnitInput.value;
            const yieldRate = parseFloat(yieldInput.value) || 100;

            const material = { price, spec, yield: yieldRate, costUnit };
            const cost = calculateCostPerUnit(material);

            const displayElement = document.getElementById('calculated-cost-display');
            if (!displayElement) return;

            if (isNaN(cost) || price <= 0 || spec <= 0) {
                displayElement.textContent = '請輸入價格和規格以計算成本...';
                displayElement.className = 'text-sm text-gray-400 mt-2';
            } else {
                displayElement.textContent = `${name || '原物料'} 的單次使用成本: ${cost.toFixed(4)} 元/${costUnit}`;
                displayElement.className = 'text-sm font-semibold text-green-500 mt-2 p-2 bg-gray-800 rounded-lg border border-green-700';
            }
        };


        /**
         * 處理原物料表單提交 (CRUD: Create/Update)
         */
        const handleMaterialSubmit = async (e) => {
            e.preventDefault();
            if (!db || !userId) {
                 showMessage('錯誤：應用程式尚未準備好。', 'error');
                 return;
            }

            const form = e.target;
            const id = form.getAttribute('data-edit-id');

            const data = {
                name: form['material-name'].value.trim(),
                price: parseFloat(form['material-price'].value) || 0,
                // 從下拉選單讀取
                priceUnit: form['material-price-unit'].value, 
                spec: parseFloat(form['material-spec'].value) || 0,
                // 從下拉選單讀取
                costUnit: form['material-cost-unit'].value, 
                yield: parseFloat(form['material-yield'].value) || 100, // 淨料率，預設 100%
                updatedAt: serverTimestamp(),
                updatedBy: userId,
            };

            if (!data.name || data.price <= 0 || data.spec <= 0) {
                showMessage('請確保名稱、價格和規格都已填寫且有效。', 'warning');
                return;
            }
            
            const materialsCollection = collection(db, getCollectionPath('materials', true));

            try {
                if (id) {
                    // 更新現有原物料
                    await updateDoc(doc(materialsCollection, id), data);
                    showMessage(`原物料「${data.name}」已更新！`, 'success');
                } else {
                    // 新增原物料
                    data.createdAt = serverTimestamp();
                    await addDoc(materialsCollection, data);
                    showMessage(`原物料「${data.name}」已新增！`, 'success');
                }
                resetMaterialForm();
            } catch (error) {
                console.error("處理原物料失敗:", error);
                showMessage(`儲存原物料失敗: ${error.message}`, 'error');
            }
        };

        /**
         * 編輯原物料
         */
        const editMaterial = (id) => {
            const material = materials[id];
            if (!material) {
                showMessage('找不到該原物料。', 'error');
                return;
            }

            const form = document.getElementById('material-form');
            form['material-name'].value = material.name;
            form['material-price'].value = material.price;
            // 設定下拉選單的值
            form['material-price-unit'].value = material.priceUnit;
            form['material-spec'].value = material.spec;
            // 設定下拉選單的值
            form['material-cost-unit'].value = material.costUnit;
            form['material-yield'].value = material.yield;
            
            form.setAttribute('data-edit-id', id);
            document.getElementById('material-submit-btn').innerHTML = '<i data-lucide="save" class="w-5 h-5 mr-2"></i> 更新原物料';
            document.getElementById('cancel-material-edit-btn').classList.remove('hidden');
            document.getElementById('material-form-title').innerHTML = '<i data-lucide="pencil" class="w-5 h-5 mr-2 text-gold"></i> 編輯現有原物料';

            updateCalculatedCostDisplay(); // 確保編輯時顯示成本
            handleTabChange('materials-tab', 'materials-content'); // 切換到原物料頁籤
            lucide.createIcons();
        };

        /**
         * 重設原物料表單
         */
        const resetMaterialForm = () => {
            const form = document.getElementById('material-form');
            form.reset();
            // 重設下拉選單到預設值
            populateUnitSelectors();
            form.removeAttribute('data-edit-id');
            document.getElementById('material-submit-btn').innerHTML = '<i data-lucide="plus" class="w-5 h-5 mr-2"></i> 新增原物料';
            document.getElementById('cancel-material-edit-btn').classList.add('hidden');
            document.getElementById('material-form-title').innerHTML = '<i data-lucide="plus" class="w-5 h-5 mr-2 text-gold"></i> 新增原物料';
            updateCalculatedCostDisplay();
            lucide.createIcons();
        };

        /**
         * 刪除原物料
         */
        const deleteMaterial = async (id) => {
            const material = materials[id];
            if (!material) return;

            // 使用自定義模態框取代 alert/confirm
            showConfirmationModal(`確定要刪除原物料「${material.name}」嗎？`, async () => {
                if (!db || !userId) {
                    showMessage('錯誤：應用程式尚未準備好。', 'error');
                    return;
                }
                try {
                    await deleteDoc(doc(db, getCollectionPath('materials', true), id));
                    showMessage(`原物料「${material.name}」已刪除。`, 'success');
                    resetMaterialForm();
                } catch (error) {
                    console.error("刪除原物料失敗:", error);
                    showMessage(`刪除失敗: ${error.message}`, 'error');
                }
            });
        };

        // --- 食譜相關函數 ---

        /**
         * 更新食譜輸入中的原物料下拉選單
         */
        const updateRecipeIngredientSelectors = () => {
            const selectorContainers = document.querySelectorAll('[data-material-select]');
            const materialArray = Object.values(materials).sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));
            
            selectorContainers.forEach(selectElement => {
                const selectedId = selectElement.value; // 記住當前選擇
                selectElement.innerHTML = '<option value="" disabled selected>選擇原物料</option>';
                
                materialArray.forEach(material => {
                    const option = document.createElement('option');
                    option.value = material.id;
                    option.textContent = `${material.name} (${material.costUnit})`;
                    selectElement.appendChild(option);
                });
                
                if (selectedId) {
                    selectElement.value = selectedId; // 恢復選擇
                }
            });
            // 由於食譜編輯/新增介面複雜，這裡只更新現有的 select 元素。
        };

        /**
         * 處理新增/編輯食譜表單提交 (CRUD: Create/Update)
         */
        const handleRecipeSubmit = async (e) => {
            e.preventDefault();
            if (!db || !userId) {
                 showMessage('錯誤：應用程式尚未準備好。', 'error');
                 return;
            }

            const form = e.target;
            const id = form.getAttribute('data-edit-id');
            const ingredientContainers = form.querySelectorAll('.recipe-ingredient-row');
            const ingredients = [];
            let isValid = true;

            ingredientContainers.forEach(container => {
                const materialId = container.querySelector('[name="material-id"]').value;
                const quantity = parseFloat(container.querySelector('[name="quantity"]').value);
                
                if (materialId && quantity > 0) {
                    ingredients.push({ materialId, quantity });
                } else if (materialId || quantity) {
                    // 如果只填了其中一個，視為無效
                    isValid = false;
                }
            });

            const data = {
                name: form['recipe-name'].value.trim(),
                yieldAmount: parseFloat(form['recipe-yield-amount'].value) || 0,
                // 從下拉選單讀取
                yieldUnit: form['recipe-yield-unit'].value, 
                packagingCost: parseFloat(form['packaging-cost'].value) || 0,
                laborCost: parseFloat(form['labor-cost'].value) || 0,
                targetMarkup: parseFloat(form['target-markup'].value) || 30,
                ingredients: ingredients,
                updatedAt: serverTimestamp(),
                updatedBy: userId,
            };

            if (!data.name || data.yieldAmount <= 0 || ingredients.length === 0 || !isValid) {
                showMessage('請確保食譜名稱、產量和至少一個有效材料與數量都已填寫。', 'warning');
                return;
            }
            
            const recipesCollection = collection(db, getCollectionPath('recipes', true));

            try {
                if (id) {
                    // 更新現有食譜
                    await updateDoc(doc(recipesCollection, id), data);
                    showMessage(`食譜「${data.name}」已更新！`, 'success');
                } else {
                    // 新增食譜
                    data.createdAt = serverTimestamp();
                    await addDoc(recipesCollection, data);
                    showMessage(`食譜「${data.name}」已新增！`, 'success');
                }
                resetRecipeForm();
            } catch (error) {
                console.error("處理食譜失敗:", error);
                showMessage(`儲存食譜失敗: ${error.message}`, 'error');
            }
        };

        /**
         * 渲染食譜清單
         */
        const renderRecipeList = () => {
            const container = document.getElementById('recipe-list-container');
            container.innerHTML = '';

            if (recipes.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">目前沒有食譜，請新增。</p>';
                return;
            }

            // 計算總覽數據
            const totalSummary = calculateTotalCost(recipes);
            document.getElementById('total-summary-display').innerHTML = `
                <div class="p-4 bg-gray-800 rounded-xl shadow-inner border border-gray-700 mb-6">
                    <h2 class="text-xl font-bold text-gold mb-3">總成本概覽 (全部食譜)</h2>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <p class="text-gray-400">總食材成本:</p>
                        <p class="font-semibold text-right text-yellow-300">$${totalSummary.totalMaterialCost.toFixed(2)}</p>
                        <p class="text-gray-400">總包裝成本:</p>
                        <p class="font-semibold text-right text-red-300">$${totalSummary.totalPackagingCost.toFixed(2)}</p>
                        <p class="text-gray-400">總人工成本:</p>
                        <p class="font-semibold text-right text-blue-300">$${totalSummary.totalLaborCost.toFixed(2)}</p>
                        <p class="text-lg text-light-text font-bold col-span-2 border-t border-gray-700 pt-2 mt-2">
                            總生產成本: <span class="float-right text-green-500">$${totalSummary.totalProductionCost.toFixed(2)}</span>
                        </p>
                    </div>
                </div>
            `;
            
            recipes.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW')).forEach(recipe => {
                const { 
                    materialCost, 
                    productionCost, 
                    costPerUnit, 
                    suggestedPrice, 
                    markup 
                } = calculateRecipeCost(recipe);

                const costDisplay = isNaN(costPerUnit) ? 'N/A' : costPerUnit.toFixed(2);
                const priceDisplay = isNaN(suggestedPrice) ? 'N/A' : suggestedPrice.toFixed(2);
                const markupDisplay = isNaN(markup) ? 'N/A' : (markup * 100).toFixed(0) + '%';
                
                const card = document.createElement('div');
                card.className = 'bg-card-bg p-5 rounded-xl shadow-lg border border-gray-700';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3 border-b border-gray-700 pb-2">
                        <h3 class="font-bold text-xl text-gold">${recipe.name}</h3>
                        <div class="flex space-x-2">
                            <button class="text-amber-400 hover:text-amber-200 p-2 rounded-full hover:bg-gray-700 transition" data-id="${recipe.id}" data-action="edit-recipe">
                                <i data-lucide="pencil" class="w-5 h-5" data-id="${recipe.id}" data-action="edit-recipe"></i>
                            </button>
                            <button class="text-red-500 hover:text-red-400 p-2 rounded-full hover:bg-gray-700 transition" data-id="${recipe.id}" data-action="delete-recipe">
                                <i data-lucide="trash-2" class="w-5 h-5" data-id="${recipe.id}" data-action="delete-recipe"></i>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <p class="text-gray-400">產量規格:</p>
                        <p class="font-semibold text-right">${recipe.yieldAmount} ${recipe.yieldUnit}</p>
                        
                        <p class="text-gray-400">總食材成本:</p>
                        <p class="font-semibold text-right">$${materialCost.toFixed(2)}</p>

                        <p class="text-gray-400">額外成本 (包裝/人工):</p>
                        <p class="font-semibold text-right">$${(recipe.packagingCost + recipe.laborCost).toFixed(2)}</p>

                        <p class="text-lg text-light-text font-bold border-t border-gray-700 pt-2 mt-2 col-span-2">
                            總生產成本: <span class="float-right text-yellow-300">$${productionCost.toFixed(2)}</span>
                        </p>
                    </div>

                    <div class="mt-4 p-3 bg-gray-700 rounded-lg">
                        <p class="text-base text-gray-300">
                            單位成本: 
                            <span class="float-right font-bold text-lg text-green-500">$${costDisplay} / ${recipe.yieldUnit}</span>
                        </p>
                        <p class="text-base text-gray-300 mt-1">
                            目標毛利 (${recipe.targetMarkup}%): 
                            <span class="float-right font-bold text-lg text-blue-400">${markupDisplay}</span>
                        </p>
                        <p class="text-base text-gray-300 mt-1">
                            **建議售價:** <span class="float-right font-bold text-2xl text-red-400">$${priceDisplay}</span>
                        </p>
                    </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        };

        /**
         * 計算單一食譜的所有成本
         */
        const calculateRecipeCost = (recipe) => {
            let materialCost = 0;
            const targetMarkup = parseFloat(recipe.targetMarkup) / 100 || 0.3;

            recipe.ingredients.forEach(item => {
                const material = materials[item.materialId];
                if (material) {
                    const costPerUnit = calculateCostPerUnit(material);
                    if (!isNaN(costPerUnit)) {
                        materialCost += costPerUnit * item.quantity;
                    }
                }
            });

            const packagingCost = parseFloat(recipe.packagingCost) || 0;
            const laborCost = parseFloat(recipe.laborCost) || 0;
            
            // 總生產成本 = 食材 + 包裝 + 人工
            const productionCost = materialCost + packagingCost + laborCost;

            const yieldAmount = parseFloat(recipe.yieldAmount) || 1;
            
            // 單位成本 = 總成本 / 產量
            const costPerUnit = productionCost / yieldAmount;

            // 建議售價 = 單位成本 / (1 - 目標毛利率)
            const suggestedPrice = costPerUnit / (1 - targetMarkup);
            
            // 實際毛利率 (基於建議售價)
            const markup = (suggestedPrice - costPerUnit) / suggestedPrice;

            return { materialCost, productionCost, costPerUnit, suggestedPrice, markup };
        };

        /**
         * 計算所有食譜的總成本
         */
        const calculateTotalCost = (recipes) => {
            let totalMaterialCost = 0;
            let totalPackagingCost = 0;
            let totalLaborCost = 0;
            let totalProductionCost = 0;

            recipes.forEach(recipe => {
                const result = calculateRecipeCost(recipe);
                totalMaterialCost += result.materialCost;
                totalPackagingCost += parseFloat(recipe.packagingCost) || 0;
                totalLaborCost += parseFloat(recipe.laborCost) || 0;
            });

            totalProductionCost = totalMaterialCost + totalPackagingCost + totalLaborCost;

            return { totalMaterialCost, totalPackagingCost, totalLaborCost, totalProductionCost };
        };


        /**
         * 刪除食譜
         */
        const deleteRecipe = async (id) => {
            const recipe = recipes.find(r => r.id === id);
            if (!recipe) return;

            showConfirmationModal(`確定要刪除食譜「${recipe.name}」嗎？`, async () => {
                if (!db || !userId) {
                    showMessage('錯誤：應用程式尚未準備好。', 'error');
                    return;
                }
                try {
                    await deleteDoc(doc(db, getCollectionPath('recipes', true), id));
                    showMessage(`食譜「${recipe.name}」已刪除。`, 'success');
                    resetRecipeForm();
                } catch (error) {
                    console.error("刪除食譜失敗:", error);
                    showMessage(`刪除失敗: ${error.message}`, 'error');
                }
            });
        };

        /**
         * 重設食譜表單
         */
        const resetRecipeForm = () => {
            const form = document.getElementById('recipe-form');
            form.reset();
            // 重設下拉選單到預設值
            populateUnitSelectors();
            form.removeAttribute('data-edit-id');
            document.getElementById('recipe-submit-btn').innerHTML = '<i data-lucide="plus" class="w-5 h-5 mr-2"></i> 新增食譜';
            document.getElementById('cancel-recipe-edit-btn').classList.add('hidden');
            document.getElementById('recipe-form-title').innerHTML = '<i data-lucide="utensils" class="w-5 h-5 mr-2 text-gold"></i> 新增食譜';
            
            // 重設配方行到只有一行
            const container = document.getElementById('ingredients-container');
            container.innerHTML = '';
            addIngredientRow(); 
            lucide.createIcons();
        };

        /**
         * 動態新增食譜配料行
         */
        const addIngredientRow = (materialId = '', quantity = '') => {
            const container = document.getElementById('ingredients-container');
            const row = document.createElement('div');
            row.className = 'recipe-ingredient-row flex space-x-2 items-center mb-2';
            row.innerHTML = `
                <select name="material-id" class="dark-input p-2 rounded-lg flex-grow border data-material-select">
                    <option value="" disabled selected>選擇原物料</option>
                </select>
                <input type="number" name="quantity" placeholder="用量" class="dark-input w-24 p-2 rounded-lg border" min="0.01" step="0.01" value="${quantity}">
                <button type="button" class="remove-ingredient-btn text-red-500 hover:text-red-400 p-1 rounded-full transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            `;
            container.appendChild(row);

            // 重新填入材料選項並設定值
            const selectElement = row.querySelector('[name="material-id"]');
            const materialArray = Object.values(materials).sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));
            materialArray.forEach(material => {
                const option = document.createElement('option');
                option.value = material.id;
                option.textContent = `${material.name} (${material.costUnit})`;
                selectElement.appendChild(option);
            });
            if (materialId) {
                selectElement.value = materialId;
            }

            // 綁定移除按鈕事件
            row.querySelector('.remove-ingredient-btn').onclick = (e) => {
                e.currentTarget.closest('.recipe-ingredient-row').remove();
            };
            lucide.createIcons();
        };

        /**
         * 編輯食譜
         */
        const editRecipe = (id) => {
            const recipe = recipes.find(r => r.id === id);
            if (!recipe) {
                showMessage('找不到該食譜。', 'error');
                return;
            }

            handleTabChange('recipes-tab', 'recipes-content'); // 確保在食譜頁籤
            
            const form = document.getElementById('recipe-form');
            form['recipe-name'].value = recipe.name;
            form['recipe-yield-amount'].value = recipe.yieldAmount;
            // 設定下拉選單的值
            form['recipe-yield-unit'].value = recipe.yieldUnit;
            form['packaging-cost'].value = recipe.packagingCost;
            form['labor-cost'].value = recipe.laborCost;
            form['target-markup'].value = recipe.targetMarkup;
            
            form.setAttribute('data-edit-id', id);
            document.getElementById('recipe-submit-btn').innerHTML = '<i data-lucide="save" class="w-5 h-5 mr-2"></i> 更新食譜';
            document.getElementById('cancel-recipe-edit-btn').classList.remove('hidden');
            document.getElementById('recipe-form-title').innerHTML = '<i data-lucide="pencil" class="w-5 h-5 mr-2 text-gold"></i> 編輯食譜';

            // 清空並重新渲染配料行
            const container = document.getElementById('ingredients-container');
            container.innerHTML = '';
            recipe.ingredients.forEach(item => {
                addIngredientRow(item.materialId, item.quantity);
            });
            // 確保至少有一行，即使配料為空
            if (recipe.ingredients.length === 0) {
                 addIngredientRow();
            }
            lucide.createIcons();
        };


        // --- 介面和輔助函數 ---

        /**
         * 顯示訊息提示
         */
        const showMessage = (message, type = 'info') => {
            const messageBox = document.getElementById('message-box');
            let colorClass = '';
            switch (type) {
                case 'success':
                    colorClass = 'bg-green-600 text-white';
                    break;
                case 'warning':
                    colorClass = 'bg-yellow-500 text-gray-900';
                    break;
                case 'error':
                    colorClass = 'bg-red-600 text-white';
                    break;
                case 'info':
                default:
                    colorClass = 'bg-blue-600 text-white';
                    break;
            }

            messageBox.textContent = message;
            messageBox.className = `p-3 rounded-lg shadow-2xl fixed bottom-4 right-4 z-50 transition-transform transform translate-y-0 ${colorClass}`;

            setTimeout(() => {
                messageBox.classList.add('translate-y-full');
            }, 3000);
            setTimeout(() => {
                messageBox.classList.remove('translate-y-full');
                messageBox.textContent = '';
            }, 3500);
        };

        /**
         * 顯示確認模態框 (取代原生 confirm)
         */
        const showConfirmationModal = (message, onConfirm) => {
            const modal = document.getElementById('confirmation-modal');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            
            document.getElementById('modal-message').textContent = message;
            
            modal.classList.remove('hidden');
            
            const handleConfirm = () => {
                onConfirm();
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };
            
            const handleCancel = () => {
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };
            
            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
        };

        /**
         * 處理 Tab 切換
         */
        const handleTabChange = (tabId, contentId) => {
            document.querySelectorAll('[data-tab-content]').forEach(content => {
                content.classList.add('hidden');
            });
            document.querySelectorAll('[data-tab]').forEach(tab => {
                tab.classList.remove('bg-gold', 'text-gray-900', 'border-b-2', 'border-gold');
                tab.classList.add('text-gray-400', 'hover:text-light-text');
            });

            document.getElementById(contentId).classList.remove('hidden');
            const currentTab = document.getElementById(tabId);
            currentTab.classList.add('bg-gold', 'text-gray-900', 'border-b-2', 'border-gold');
            currentTab.classList.remove('text-gray-400', 'hover:text-light-text');
            
            // 確保在切換到食譜或總覽時，資料是最新狀態
            if (contentId === 'recipes-view-content') {
                renderRecipeList();
            } else if (contentId === 'materials-content') {
                updateCalculatedCostDisplay();
            }
        };

        // --- 啟動應用程式 ---

        window.onload = function() {
            initializeFirebase(); // 啟動 Firebase 和身份驗證

            // 預設顯示原物料頁籤
            handleTabChange('materials-tab', 'materials-content');

            // 綁定 Tab 切換事件
            document.querySelectorAll('[data-tab]').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const contentId = e.currentTarget.getAttribute('data-target');
                    handleTabChange(e.currentTarget.id, contentId);
                });
            });

            // 綁定原物料表單事件
            const materialForm = document.getElementById('material-form');
            if (materialForm) {
                materialForm.addEventListener('submit', handleMaterialSubmit);
                materialForm['material-price'].addEventListener('input', updateCalculatedCostDisplay);
                materialForm['material-spec'].addEventListener('input', updateCalculatedCostDisplay);
                materialForm['material-yield'].addEventListener('input', updateCalculatedCostDisplay);
                // 單位欄位現在是 select，也綁定 input 事件
                materialForm['material-cost-unit'].addEventListener('input', updateCalculatedCostDisplay); 
                document.getElementById('cancel-material-edit-btn').addEventListener('click', resetMaterialForm);
            }

            // 綁定原物料列表編輯/刪除事件
            document.getElementById('material-list-container').addEventListener('click', (e) => {
                const id = e.target.getAttribute('data-id');
                const action = e.target.getAttribute('data-action');
                if (id && action) {
                    if (action === 'edit') {
                        editMaterial(id);
                    } else if (action === 'delete') {
                        deleteMaterial(id);
                    }
                }
            });

            // 綁定食譜表單事件
            const recipeForm = document.getElementById('recipe-form');
            if (recipeForm) {
                recipeForm.addEventListener('submit', handleRecipeSubmit);
                document.getElementById('add-ingredient-btn').addEventListener('click', () => addIngredientRow());
                document.getElementById('cancel-recipe-edit-btn').addEventListener('click', resetRecipeForm);
                // 初始化第一行配料
                addIngredientRow();
            }

            // 綁定食譜列表編輯/刪除事件
            document.getElementById('recipe-list-container').addEventListener('click', (e) => {
                const id = e.target.getAttribute('data-id');
                const action = e.target.getAttribute('data-action');
                if (id && action) {
                    if (action === 'edit-recipe') {
                        editRecipe(id);
                    } else if (action === 'delete-recipe') {
                        deleteRecipe(id);
                    }
                }
            });

            lucide.createIcons();
        };

    </script>
</head>
<body class="bg-dark-bg text-light-text font-sans antialiased min-h-screen p-4 sm:p-8" style="font-family: 'Inter', sans-serif;">

    <!-- 確認模態框 -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-card-bg p-6 rounded-xl shadow-2xl max-w-sm w-full border border-gray-700">
            <h3 class="text-xl font-bold text-red-500 mb-4">確認操作</h3>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500 transition">取消</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-500 transition">確定刪除</button>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <!-- 標題與協作資訊 -->
        <header class="mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-3xl font-extrabold text-gold flex items-center">
                <i data-lucide="calculator" class="w-8 h-8 mr-3"></i> 連線協作成本計算器
            </h1>
            <p class="text-sm text-gray-500 mt-1">即時同步資料，多人協作制定定價策略。</p>
            <p class="text-xs text-gray-600 mt-2">協作 ID: <span id="user-id-display" class="font-mono text-gray-400">連線中...</span></p>
        </header>

        <!-- Tab 導航 -->
        <div class="flex border-b border-gray-700 mb-6">
            <button id="materials-tab" data-tab data-target="materials-content" class="tab-button flex-1 py-3 px-4 text-center font-semibold rounded-t-lg transition">
                <i data-lucide="wheat" class="w-4 h-4 inline mr-2"></i> 1. 原物料管理
            </button>
            <button id="recipes-tab" data-tab data-target="recipes-content" class="tab-button flex-1 py-3 px-4 text-center font-semibold rounded-t-lg transition">
                <i data-lucide="utensils" class="w-4 h-4 inline mr-2"></i> 2. 食譜與定價
            </button>
            <button id="recipes-view-tab" data-tab data-target="recipes-view-content" class="tab-button flex-1 py-3 px-4 text-center font-semibold rounded-t-lg transition">
                <i data-lucide="bar-chart-3" class="w-4 h-4 inline mr-2"></i> 3. 總覽與分析
            </button>
        </div>

        <!-- 內容區塊 1: 原物料管理 -->
        <div id="materials-content" data-tab-content class="space-y-8">
            <!-- 新增/編輯原物料表單 -->
            <div class="bg-card-bg p-6 rounded-xl shadow-xl border-t-4 border-gold">
                <h2 id="material-form-title" class="text-xl font-bold mb-4 text-light-text flex items-center">
                    <i data-lucide="plus" class="w-5 h-5 mr-2 text-gold"></i> 新增原物料
                </h2>
                <form id="material-form" data-edit-id="" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- 名稱 -->
                    <div class="sm:col-span-2">
                        <label for="material-name" class="block text-sm font-medium text-gray-400 mb-1">原物料名稱 (例如：麵粉、奶油)</label>
                        <input type="text" id="material-name" name="material-name" required class="dark-input w-full p-3 rounded-lg ring-gold ring-1 focus:ring-2" placeholder="麵粉 T55">
                    </div>

                    <!-- 價格與單位 -->
                    <div>
                        <label for="material-price" class="block text-sm font-medium text-gray-400 mb-1">採購單價 ($)</label>
                        <input type="number" id="material-price" name="material-price" required min="0.01" step="0.01" class="dark-input w-full p-3 rounded-lg ring-gold ring-1 focus:ring-2" placeholder="500">
                    </div>
                    <!-- 採購價格單位 (下拉選單) -->
                    <div>
                        <label for="material-price-unit" class="block text-sm font-medium text-gray-400 mb-1">採購價格單位</label>
                        <select id="material-price-unit" name="material-price-unit" required class="dark-input w-full p-3 rounded-lg ring-gold ring-1 focus:ring-2">
                            <!-- 選項將由 JS 填充 -->
                        </select>
                    </div>

                    <!-- 規格與成本單位 -->
                    <div>
                        <label for="material-spec" class="block text-sm font-medium text-gray-400 mb-1">採購規格量 (淨重)</label>
                        <input type="number" id="material-spec" name="material-spec" required min="0.01" step="0.01" class="dark-input w-full p-3 rounded-lg ring-gold ring-1 focus:ring-2" placeholder="25000">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <!-- 成本核算單位 (下拉選單) -->
                        <div>
                            <label for="material-cost-unit" class="block text-sm font-medium text-gray-400 mb-1">成本核算單位</label>
                            <select id="material-cost-unit" name="material-cost-unit" required class="dark-input w-full p-3 rounded-lg ring-gold ring-1 focus:ring-2">
                                <!-- 選項將由 JS 填充 -->
                            </select>
                        </div>
                        <div>
                            <label for="material-yield" class="block text-sm font-medium text-gray-400 mb-1">淨料率 (%)</label>
                            <input type="number" id="material-yield" name="material-yield" min="0" max="100" step="0.1" value="100" class="dark-input w-full p-3 rounded-lg ring-gold ring-1 focus:ring-2" placeholder="100">
                        </div>
                    </div>

                    <!-- 計算結果顯示 -->
                    <div class="sm:col-span-2">
                         <div id="calculated-cost-display" class="text-sm text-gray-400 mt-2">請輸入價格和規格以計算成本...</div>
                    </div>
                    
                    <!-- 按鈕 -->
                    <div class="sm:col-span-2 flex space-x-3">
                        <button type="submit" id="material-submit-btn" class="flex-1 flex items-center justify-center bg-gold text-gray-900 font-bold py-3 rounded-xl hover:bg-amber-500 transition shadow-lg">
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i> 新增原物料
                        </button>
                        <button type="button" id="cancel-material-edit-btn" class="hidden flex-shrink-0 flex items-center justify-center bg-gray-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-gray-500 transition">
                            <i data-lucide="x" class="w-5 h-5"></i> 取消編輯
                        </button>
                    </div>
                </form>
            </div>

            <!-- 原物料清單 -->
            <div class="bg-card-bg p-6 rounded-xl shadow-xl border-t-4 border-gray-500">
                <h2 class="text-xl font-bold mb-4 text-light-text flex items-center">
                    <i data-lucide="list-ordered" class="w-5 h-5 mr-2 text-gray-400"></i> 現有原物料清單
                </h2>
                <div id="material-list-container" class="space-y-4 scrollable-list max-h-96 overflow-y-auto">
                    <!-- 原物料列表將由 JS 渲染至此 -->
                    <p class="text-center text-gray-500 py-4">連線中，請稍候...</p>
                </div>
            </div>
        </div>

        <!-- 內容區塊 2: 食譜與定價 -->
        <div id="recipes-content" data-tab-content class="hidden space-y-8">
            <div class="bg-card-bg p-6 rounded-xl shadow-xl border-t-4 border-gold">
                <h2 id="recipe-form-title" class="text-xl font-bold mb-4 text-light-text flex items-center">
                    <i data-lucide="utensils" class="w-5 h-5 mr-2 text-gold"></i> 新增食譜
                </h2>
                <form id="recipe-form" data-edit-id="">
                    <!-- 基本資訊 -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="recipe-name" class="block text-sm font-medium text-gray-400 mb-1">食譜/品項名稱</label>
                            <input type="text" id="recipe-name" name="recipe-name" required class="dark-input w-full p-3 rounded-lg ring-gold ring-1 focus:ring-2" placeholder="經典法棍麵包">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label for="recipe-yield-amount" class="block text-sm font-medium text-gray-400 mb-1">產出數量</label>
                                <input type="number" id="recipe-yield-amount" name="recipe-yield-amount" required min="1" step="0.01" class="dark-input w-full p-3 rounded-lg ring-gold ring-1 focus:ring-2" placeholder="10">
                            </div>
                            <!-- 產量單位 (下拉選單) -->
                            <div>
                                <label for="recipe-yield-unit" class="block text-sm font-medium text-gray-400 mb-1">產量單位</label>
                                <select id="recipe-yield-unit" name="recipe-yield-unit" required class="dark-input w-full p-3 rounded-lg ring-gold ring-1 focus:ring-2">
                                    <!-- 選項將由 JS 填充 -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-light-text mb-3 border-b border-gray-700 pb-2 flex justify-between items-center">
                        食材配方 (連線同步)
                        <button type="button" id="add-ingredient-btn" class="text-gold hover:text-amber-500 text-sm font-medium flex items-center">
                            <i data-lucide="plus-circle" class="w-4 h-4 mr-1"></i> 新增材料
                        </button>
                    </h3>
                    <div id="ingredients-container" class="space-y-2 mb-6 scrollable-list max-h-56 overflow-y-auto p-1">
                        <!-- 動態配料輸入行將由 JS 渲染至此 -->
                    </div>

                    <!-- 額外成本與定價目標 -->
                    <h3 class="text-lg font-semibold text-light-text mb-3 border-b border-gray-700 pb-2">其他成本與目標</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label for="packaging-cost" class="block text-sm font-medium text-gray-400 mb-1">單批次包裝成本 ($)</label>
                            <input type="number" id="packaging-cost" name="packaging-cost" min="0" step="0.01" value="0" class="dark-input w-full p-3 rounded-lg ring-gold ring-1 focus:ring-2">
                        </div>
                        <div>
                            <label for="labor-cost" class="block text-sm font-medium text-gray-400 mb-1">單批次人工成本 ($)</label>
                            <input type="number" id="labor-cost" name="labor-cost" min="0" step="0.01" value="0" class="dark-input w-full p-3 rounded-lg ring-gold ring-1 focus:ring-2">
                        </div>
                        <div>
                            <label for="target-markup" class="block text-sm font-medium text-gray-400 mb-1">目標毛利率 (%)</label>
                            <input type="number" id="target-markup" name="target-markup" required min="1" max="99" step="1" value="30" class="dark-input w-full p-3 rounded-lg ring-gold ring-1 focus:ring-2">
                        </div>
                    </div>

                    <!-- 按鈕 -->
                    <div class="flex space-x-3">
                        <button type="submit" id="recipe-submit-btn" class="flex-1 flex items-center justify-center bg-gold text-gray-900 font-bold py-3 rounded-xl hover:bg-amber-500 transition shadow-lg">
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i> 新增食譜
                        </button>
                        <button type="button" id="cancel-recipe-edit-btn" class="hidden flex-shrink-0 flex items-center justify-center bg-gray-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-gray-500 transition">
                            <i data-lucide="x" class="w-5 h-5"></i> 取消編輯
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 內容區塊 3: 總覽與分析 -->
        <div id="recipes-view-content" data-tab-content class="hidden space-y-6">
            <div id="total-summary-display">
                <!-- 總成本概覽將由 JS 渲染至此 -->
                <div class="p-4 bg-gray-800 rounded-xl shadow-inner border border-gray-700 mb-6">
                    <h2 class="text-xl font-bold text-gold mb-3">總成本概覽 (全部食譜)</h2>
                    <p class="text-center text-gray-500 py-4">正在計算中...</p>
                </div>
            </div>

            <h2 class="text-2xl font-bold text-light-text flex items-center border-b border-gray-700 pb-3">
                <i data-lucide="scroll-text" class="w-6 h-6 mr-2 text-gold"></i> 食譜定價分析 (連線同步)
            </h2>
            
            <div id="recipe-list-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 食譜列表將由 JS 渲染至此 -->
                <p class="text-center text-gray-500 md:col-span-2 py-8">連線中，請稍候...</p>
            </div>
        </div>

    </div>

    <!-- 訊息提示框 -->
    <div id="message-box" class="p-3 rounded-lg shadow-2xl fixed bottom-4 right-4 z-50 transition-transform transform translate-y-full opacity-90 text-sm"></div>

</body>
</html>