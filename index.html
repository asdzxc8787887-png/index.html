<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿè­œæˆæœ¬è¨ˆç®—èˆ‡ç®¡ç†ç³»çµ± - é›²ç«¯å”ä½œç‰ˆ</title>
    
    <!-- PWA / App ç›¸é—œ Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#171717">

    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Inter å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Lucide Icons for a professional look -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- å¼•å…¥ Firebase SDK (é‡è¦ï¼šç‚ºäº†å¯¦ç¾é›²ç«¯å”ä½œ) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, setLogLevel, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // å°‡ Firebase ç›¸é—œè®Šæ•¸æ›è¼‰åˆ° windowï¼Œä»¥ä¾¿æ ¸å¿ƒé‚è¼¯ä½¿ç”¨
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, setLogLevel, addDoc,
            setPersistence, browserSessionPersistence
        };
    </script>

    <style>
        /* å®šç¾©é»‘é‡‘è‰²èª¿ */
        :root {
            --color-dark-primary: #171717; /* æ¥è¿‘é»‘è‰²çš„æ·±è‰²èƒŒæ™¯ */
            --color-dark-secondary: #262626; /* å¡ç‰‡èƒŒæ™¯/å€å¡ŠèƒŒæ™¯ */
            --color-gold-accent: #D4AF37; /* é‡‘è‰²å¼·èª¿è‰² */
            --color-gold-hover: #E8C15E; 
            --color-text-light: #F5F5F5; /* æ·ºè‰²æ–‡å­— */
            --color-text-medium: #A3A3A3; /* æ¬¡è¦æ–‡å­— */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-dark-primary); 
            color: var(--color-text-light);
        }
        
        .app-card {
            background-color: var(--color-dark-secondary);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            border: 1px solid #3f3f46; /* Slate 700 é‚Šæ¡† */
        }
        
        /* Tab æŒ‰éˆ•æ¨£å¼ */
        .tab-button {
            color: var(--color-text-medium);
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            border-bottom: 3px solid var(--color-gold-accent); 
            color: var(--color-gold-accent);
            font-weight: 600;
        }

        /* è¼¸å…¥æ¡†/ä¸‹æ‹‰é¸å–®çš„æ·±è‰²æ¨£å¼ */
        input:not([type="submit"]), select {
            background-color: #3f3f46; /* Slate 700 */
            border-color: #52525B; /* Slate 600 */
            color: var(--color-text-light);
        }
        input:focus, select:focus, button:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--color-gold-accent); /* é‡‘è‰² Focus Ring */
            border-color: var(--color-gold-accent);
        }

        /* ä¸»è¦æŒ‰éˆ• (é‡‘è‰²) */
        .btn-primary {
            background-color: var(--color-gold-accent);
            color: var(--color-dark-primary); /* æ·±è‰²å­—é«”ä»¥ç¢ºä¿å°æ¯” */
            font-weight: 700;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--color-gold-hover);
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4);
        }

        /* è¼”åŠ©æŒ‰éˆ• (æ·±è‰²/ç°è‰²) */
        .btn-secondary {
            background-color: #52525B; /* Slate 600 */
            color: var(--color-text-light);
        }
        .btn-secondary:hover {
            background-color: #64748B; /* Slate 500 */
        }
        
        /* åŒ¯å‡ºæŒ‰éˆ• (ç‰¹åˆ¥çš„æ·±è‰²) */
        .btn-export {
            background-color: #047857; /* Emerald 700 */
            color: white; 
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-export:hover {
            background-color: #059669; /* Emerald 600 */
        }

        /* éš±è—æ•¸å­—è¼¸å…¥ç®­é ­ */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* æ•¸æ“šé¡¯ç¤ºå€å¡Š */
        .data-display-box {
            background-color: #3f3f46; /* Slate 700 */
            border: 1px solid var(--color-gold-accent);
            color: var(--color-text-light);
        }
        
        /* å”ä½œç‹€æ…‹é¡¯ç¤º */
        #collaboration-status {
            background-color: #047857; /* Emerald 700 */
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 1rem;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
          0% { box-shadow: 0 0 0 0 rgba(4, 120, 87, 0.7); }
          70% { box-shadow: 0 0 0 8px rgba(4, 120, 87, 0); }
          100% { box-shadow: 0 0 0 0 rgba(4, 120, 87, 0); }
        }

    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app-container" class="max-w-7xl mx-auto rounded-2xl app-card p-6 md:p-10">
        <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold flex items-center text-white">
                <i data-lucide="calculator" class="w-7 h-7 mr-3" style="color: var(--color-gold-accent);"></i>
                é£Ÿè­œæˆæœ¬åˆ†æèˆ‡ç®¡ç† (é›²ç«¯å”ä½œæ¨¡å¼)
                <span id="collaboration-status" class="flex items-center">
                    <i data-lucide="cloud" class="w-4 h-4 mr-1"></i>
                    é€£ç·šä¸­
                </span>
            </h1>
        </header>

        <!-- å°èˆªåˆ†é  -->
        <div class="flex border-b mb-6 sticky top-0 z-10" style="border-color: #3f3f46; background-color: var(--color-dark-secondary);">
            <button id="tab-materials" data-tab="materials" class="tab-button active flex-1 py-3 px-2 transition duration-150 ease-in-out text-base md:text-lg">
                <i data-lucide="database" class="w-5 h-5 inline-block md:mr-2 align-text-bottom"></i>
                <span class="hidden md:inline">åŸç‰©æ–™</span>è³‡æ–™åº«
            </button>
            <button id="tab-recipes" data-tab="recipes" class="tab-button flex-1 py-3 px-2 transition duration-150 ease-in-out text-base md:text-lg">
                <i data-lucide="book-open-check" class="w-5 h-5 inline-block md:mr-2 align-text-bottom"></i>
                <span class="hidden md:inline">é£Ÿè­œ</span>æˆæœ¬è¨ˆç®—å™¨
            </button>
        </div>

        <!-- åŸç‰©æ–™è³‡æ–™åº«å…§å®¹ -->
        <div id="tab-content-materials" class="tab-content">
            <div class="flex justify-between items-center mb-4 border-b pb-2" style="border-color: #3f3f46;">
                <h2 class="text-2xl font-semibold text-white">åŸç‰©æ–™è³‡æ–™åº«</h2>
                <button id="export-materials-btn" class="p-2 rounded-lg text-sm btn-export flex items-center">
                     <i data-lucide="file-text" class="w-4 h-4 mr-1"></i> åŒ¯å‡º CSV
                </button>
            </div>


            <!-- æ–°å¢/ç·¨è¼¯åŸç‰©æ–™è¡¨å–® (ç§»åˆ°æœ€ä¸Šæ–¹) -->
            <div class="mb-8 p-5 md:p-7 rounded-xl shadow-xl" style="background-color: #262626; border: 1px solid var(--color-gold-accent);">
                <h3 class="text-xl font-bold mb-4 flex items-center" style="color: var(--color-gold-accent);">
                     <i data-lucide="square-pen" class="w-5 h-5 mr-2"></i>
                    æ–°å¢/ç·¨è¼¯åŸç‰©æ–™é …ç›®
                </h3>
                <form id="material-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4">
                    <input type="hidden" id="material-id">

                    <!-- åŸºæœ¬è³‡è¨Š (2 æ¬„ä½) -->
                    <div class="lg:col-span-2">
                        <label for="material-name" class="block text-sm font-medium" style="color: var(--color-text-medium);">ææ–™åç¨± (å¿…å¡«)</label>
                        <input type="text" id="material-name" placeholder="éºµç²‰ã€ç³–ã€å¥¶æ²¹..." required class="mt-1 w-full p-2 rounded-lg text-sm">
                    </div>
                    <div class="lg:col-span-2">
                        <label for="material-supplier" class="block text-sm font-medium" style="color: var(--color-text-medium);">ä¾›è²¨å•† (é¸å¡«)</label>
                        <input type="text" id="material-supplier" placeholder="A ç‰Œã€B ç‰Œ..." class="mt-1 w-full p-2 rounded-lg text-sm">
                    </div>
                    <div class="lg:col-span-2">
                        <label for="material-yield" class="block text-sm font-medium" style="color: var(--color-text-medium);">å¯ä½¿ç”¨å¾—ç‡ (%)</label>
                        <input type="number" id="material-yield" placeholder="å¾—ç‡ (%) e.g. 95.5" required min="0.01" max="100" step="0.01" class="mt-1 w-full p-2 rounded-lg text-sm text-right">
                    </div>
                    
                    <!-- æ¡è³¼è³‡è¨Š (3 æ¬„ä½) -->
                    <div>
                        <label for="material-price" class="block text-sm font-medium" style="color: var(--color-text-medium);">é€²åƒ¹/åŒ… (æœªç¨…, å…ƒ)</label>
                        <input type="number" id="material-price" placeholder="åƒ¹æ ¼" required min="0.01" step="0.01" class="mt-1 w-full p-2 rounded-lg text-sm text-right">
                    </div>
                    <div>
                        <label for="material-spec" class="block text-sm font-medium" style="color: var(--color-text-medium);">æ¡è³¼è¦æ ¼ (ç¸½æ•¸é‡)</label>
                        <input type="number" id="material-spec" placeholder="æ•¸é‡" required min="0.01" step="0.01" class="mt-1 w-full p-2 rounded-lg text-sm text-right">
                    </div>
                    <div>
                        <label for="material-cost-unit" class="block text-sm font-medium" style="color: var(--color-text-medium);">è¦æ ¼å–®ä½ (æœ€å°è¨ˆç®—å–®ä½)</label>
                        <select id="material-cost-unit" required class="mt-1 w-full p-2 rounded-lg text-sm">
                            <option value="" disabled selected>é¸æ“‡å–®ä½</option>
                            <!-- ç¢ºä¿é¸é …åœ¨æ·±è‰²èƒŒæ™¯ä¸‹å¯è®€ -->
                            <option value="kg" class="bg-gray-700 text-white">å…¬æ–¤ (kg)</option>
                            <option value="g" class="bg-gray-700 text-white">å…¬å…‹ (g)</option>
                            <option value="L" class="bg-gray-700 text-white">å…¬å‡ (L)</option>
                            <option value="ml" class="bg-gray-700 text-white">æ¯«å‡ (ml)</option>
                            <option value="unit" class="bg-gray-700 text-white">å€‹/å–®ä½ (unit)</option>
                            <option value="åŒ…" class="bg-gray-700 text-white">åŒ… (åŒ…)</option> <!-- æ–°å¢ 'åŒ…' -->
                        </select>
                    </div>

                    <!-- è¨ˆç®—çµæœèˆ‡æŒ‰éˆ• (2 æ¬„ä½) -->
                    <div class="sm:col-span-2 lg:col-span-3 pt-3">
                        <p class="text-sm font-medium" style="color: var(--color-text-medium);">è¨ˆç®—å‡ºçš„å–®åƒ¹ (å…ƒ/å–®ä½)</p>
                        <p class="text-3xl font-extrabold text-white" style="color: var(--color-gold-accent);">
                            <span id="calculated-yield-cost">0.0000</span> / <span id="calculated-cost-unit">å–®ä½</span>
                        </p>
                    </div>

                    <div class="sm:col-span-2 lg:col-span-3 pt-3 flex items-end">
                        <button type="submit" id="material-submit-btn" class="w-full p-3 rounded-lg btn-primary shadow-md hover:shadow-lg">
                            <i data-lucide="plus" class="w-5 h-5 inline-block mr-2"></i>
                            æ–°å¢åŸç‰©æ–™
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- åŸç‰©æ–™åˆ—è¡¨ (ç§»åˆ°ä¸‹æ–¹) -->
            <h3 class="text-xl font-semibold mb-4 border-b pb-2 text-white" style="border-color: #3f3f46;">å·²å„²å­˜çš„åŸç‰©æ–™æ¸…å–® (é›²ç«¯åŒæ­¥)</h3>
            <div id="material-list-container" class="scroll-container bg-transparent p-0 md:p-2 rounded-xl">
                <!-- åŸç‰©æ–™åˆ—è¡¨å°‡åœ¨é€™è£¡æ¸²æŸ“ -->
                <div id="material-list" class="space-y-4">
                    <p class="text-center py-6" style="color: var(--color-text-medium);">æ­£åœ¨é€£ç·šåˆ°é›²ç«¯è³‡æ–™åº«...</p>
                </div>
            </div>
        </div>

        <!-- é£Ÿè­œæˆæœ¬è¨ˆç®—å™¨å…§å®¹ -->
        <div id="tab-content-recipes" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4 border-b pb-2" style="border-color: #3f3f46;">
                <h2 class="text-2xl font-semibold text-white">é£Ÿè­œæˆæœ¬è¨ˆç®—å™¨</h2>
                <button id="export-recipes-btn" class="p-2 rounded-lg text-sm btn-export flex items-center">
                     <i data-lucide="file-text" class="w-4 h-4 mr-1"></i> åŒ¯å‡º CSV
                </button>
            </div>

            
            <!-- æ–°å¢é£Ÿè­œ/è¨ˆç®—å™¨å€åŸŸ (ç§»åˆ°æœ€ä¸Šæ–¹) -->
            <div id="recipe-calculator" class="mb-8 p-5 md:p-7 rounded-xl shadow-xl" style="background-color: #262626; border: 1px solid var(--color-text-medium);">
                <h3 class="text-xl font-bold mb-4 flex items-center text-white">
                    <i data-lucide="chef-hat" class="w-5 h-5 mr-2" style="color: var(--color-gold-accent);"></i>
                    ç·¨è¼¯é£Ÿè­œèˆ‡æˆæœ¬åˆ†æ
                </h3>
                <form id="recipe-form" class="space-y-6">
                    <input type="hidden" id="recipe-doc-id">
                    
                    <div>
                        <label for="recipe-name" class="block text-sm font-medium" style="color: var(--color-text-medium);">é£Ÿè­œ/ç”¢å“åç¨±</label>
                        <input type="text" id="recipe-name" placeholder="é£Ÿè­œåç¨± (e.g., è‰è“è›‹ç³•)" required class="w-full p-3 text-lg rounded-lg focus:ring-amber-500 focus:border-amber-500 mt-1">
                    </div>
                    
                    <!-- é£Ÿææ¸…å–® -->
                    <div>
                        <label class="block text-sm font-bold mb-2 text-white">é£Ÿææ¸…å–® (ä½¿ç”¨æ•¸é‡)</label>
                        <div id="ingredient-input-container" class="space-y-3 p-3 rounded-lg" style="border: 1px solid #52525B; background-color: #171717;">
                            <!-- å‹•æ…‹æ–°å¢çš„é£Ÿæè¼¸å…¥æ¬„ä½æœƒåœ¨é€™è£¡ -->
                            <p class="text-sm italic text-center py-2" style="color: var(--color-text-medium);">è«‹åœ¨ä¸‹æ–¹æ–°å¢é£Ÿæã€‚</p>
                        </div>
                        <button type="button" id="add-ingredient-btn" class="text-sm font-medium flex items-center mt-3 p-2 rounded-md transition" style="color: var(--color-gold-accent); border: 1px dashed var(--color-gold-accent);">
                            <i data-lucide="plus-circle" class="w-5 h-5 mr-1"></i>
                            æ–°å¢é£Ÿæé …ç›®
                        </button>
                    </div>


                    <!-- æˆæœ¬/å”®åƒ¹è¨ˆç®—çµæœ -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 border-t pt-4 mt-4" style="border-color: #3f3f46;">
                        <!-- ç¸½æˆæœ¬ -->
                        <div class="col-span-1 data-display-box p-3 rounded-lg">
                            <p class="text-sm font-medium" style="color: var(--color-text-medium);">ç¸½é£Ÿææˆæœ¬</p>
                            <p class="text-2xl font-extrabold mt-1 text-green-400">
                                <span id="calculated-cost">0.00</span> <span class="text-base" style="color: var(--color-text-light);">å…ƒ</span>
                            </p>
                        </div>

                        <!-- ç›®æ¨™æ¯›åˆ©ç‡ -->
                        <div class="col-span-1 data-display-box p-3 rounded-lg">
                            <label for="recipe-target-margin" class="block text-sm font-medium" style="color: var(--color-text-medium);">ç›®æ¨™æ¯›åˆ©ç‡ (%)</label>
                            <input type="number" id="recipe-target-margin" value="50" min="0" max="100" step="1" 
                                class="w-full p-2 rounded-lg text-xl font-bold text-center mt-1 text-red-400"
                                oninput="calculateCurrentRecipeCost()" style="background-color: #52525B;">
                        </div>
                        
                        <!-- å»ºè­°å”®åƒ¹ -->
                        <div class="col-span-1 data-display-box p-3 rounded-lg">
                            <p class="text-sm font-medium" style="color: var(--color-text-medium);">å»ºè­°å”®åƒ¹ (æœªç¨…)</p>
                            <p class="text-2xl font-extrabold mt-1" style="color: var(--color-gold-accent);">
                                <span id="calculated-selling-price">0.00</span> <span class="text-base" style="color: var(--color-text-light);">å…ƒ</span>
                            </p>
                        </div>
                    </div>
                    
                    <!-- å„²å­˜æŒ‰éˆ• -->
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="cancel-recipe-edit-btn" class="p-3 rounded-lg font-semibold shadow-md btn-secondary">
                            <i data-lucide="x" class="w-5 h-5 inline-block mr-1"></i>
                            å–æ¶ˆ
                        </button>
                        <button type="submit" id="recipe-submit-btn" class="p-3 rounded-lg font-semibold shadow-md btn-primary">
                            <i data-lucide="save" class="w-5 h-5 inline-block mr-1"></i>
                            å„²å­˜é£Ÿè­œ
                        </button>
                    </div>
                </form>
            </div>

            <!-- é£Ÿè­œåˆ—è¡¨ (ç§»åˆ°ä¸‹æ–¹) -->
            <h3 class="text-xl font-semibold mb-4 border-b pb-2 text-white" style="border-color: #3f3f46;">å·²å„²å­˜çš„é£Ÿè­œæ¸…å–® (é›²ç«¯åŒæ­¥)</h3>
            <div id="recipe-list-container" class="scroll-container bg-transparent p-0 md:p-2 rounded-xl">
                <div id="recipe-list" class="space-y-4">
                    <p class="text-center py-6" style="color: var(--color-text-medium);">æ­£åœ¨é€£ç·šåˆ°é›²ç«¯è³‡æ–™åº«...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åˆå§‹åŒ– Lucide Icons -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>

    <!-- æ ¸å¿ƒé›²ç«¯ JavaScript é‚è¼¯ -->
    <script>
        // --- æ ¸å¿ƒå…¨åŸŸè®Šæ•¸ ---
        let materials = {}; // å„²å­˜åŸç‰©æ–™æ•¸æ“š { id: materialData }
        let recipes = []; // å„²å­˜é£Ÿè­œæ•¸æ“š
        
        // --- Firebase/Firestore ç›¸é—œå…¨åŸŸè®Šæ•¸ ---
        
        // ğŸš¨ ä¿®æ­£: å„ªå…ˆä½¿ç”¨ Canvas ç’°å¢ƒæä¾›çš„å…¨åŸŸè®Šæ•¸
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // è¼”åŠ©å‡½å¼ï¼šç”¢ç”Ÿå”¯ä¸€ ID
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 9);


        // å–®ä½æ›ç®—åˆ†çµ„åŠä¹˜æ•¸è¡¨ (èˆ‡å–®æ©Ÿç‰ˆç›¸åŒ)
        const UNIT_GROUPS = {
            'g': { // é‡é‡åŸºæº–å–®ä½ï¼šg (å…¬å…‹)
                'g': 1,
                'kg': 1000,
            },
            'ml': { // å®¹é‡åŸºæº–å–®ä½ï¼šml (æ¯«å‡)
                'ml': 1,
                'L': 1000,
            },
            'unit': { // å–®ä½åŸºæº–å–®ä½ï¼šunit (å€‹/å–®ä½)
                'unit': 1,
                'åŒ…': 1, // å°‡ 'åŒ…' è¦–ç‚º 'unit' çš„åˆ¥å
            }
        };

        // è¼”åŠ©å‡½å¼ï¼šå–å¾—å–®ä½åç¨± (å”¯ä¸€çš„å®šç¾©)
        const getUnitName = (unit) => {
            switch(unit) {
                case 'kg': return 'å…¬æ–¤';
                case 'g': return 'å…¬å…‹';
                case 'L': return 'å…¬å‡';
                case 'ml': return 'æ¯«å‡';
                case 'unit': return 'å–®ä½';
                case 'åŒ…': return 'åŒ…';
                default: return unit;
            }
        };
        
        // --- Firebase/Firestore é‚è¼¯ ---

        // Firestore è³‡æ–™è·¯å¾‘ (ä½¿ç”¨å…¬å…±è·¯å¾‘å¯¦ç¾å”ä½œ)
        const getCollectionPath = (collectionName) => {
            // ä½¿ç”¨å…¬å…±è·¯å¾‘å¯¦ç¾å¤šç”¨æˆ¶é–“çš„è³‡æ–™å…±äº«: /artifacts/{appId}/public/data/{collectionName}
            return `artifacts/${appId}/public/data/${collectionName}`;
        };

        // 1. åˆå§‹åŒ– Firebase å’Œèªè­‰
        const initializeFirebase = async () => {
            if (!firebaseConfig) {
                console.error("Firebase é…ç½®éºå¤±ã€‚æ‡‰ç”¨ç¨‹å¼å°‡ç„¡æ³•ä½¿ç”¨é›²ç«¯åŠŸèƒ½ã€‚");
                document.getElementById('collaboration-status').textContent = 'é€£ç·šå¤±æ•— (é…ç½®éºå¤±)';
                document.getElementById('collaboration-status').style.backgroundColor = 'red';
                return;
            }

            try {
                const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, setLogLevel } = window.firebase;
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // å•Ÿç”¨ FireStore æ—¥èªŒ

                // è¨­ç½®èº«ä»½é©—è­‰ç›£è½å™¨
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase èªè­‰æˆåŠŸï¼ŒUser ID:", userId);
                        isAuthReady = true;
                        // èªè­‰å®Œæˆå¾Œï¼Œé–‹å§‹è¨­å®šå³æ™‚è³‡æ–™ç›£è½
                        setupRealtimeListeners(); 
                        document.getElementById('collaboration-status').textContent = 'å·²é€£ç·š (å”ä½œæ¨¡å¼)';
                        lucide.createIcons();
                    } else {
                        console.log("å˜—è©¦ç™»å…¥ä¸­...");
                        
                        // å˜—è©¦ä½¿ç”¨ Custom Token ç™»å…¥ï¼Œå¦‚æœæ²’æœ‰å‰‡åŒ¿åç™»å…¥
                        if (initialAuthToken) {
                            console.log("ä½¿ç”¨ Custom Token ç™»å…¥...");
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            console.log("ä½¿ç”¨åŒ¿åç™»å…¥...");
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–æˆ–èªè­‰å¤±æ•—:", error);
                document.getElementById('collaboration-status').textContent = 'é€£ç·šéŒ¯èª¤ (è«‹æª¢æŸ¥é…ç½®)';
                document.getElementById('collaboration-status').style.backgroundColor = 'red';
            }
        };

        // 2. è¨­ç½®å³æ™‚ç›£è½å™¨
        const setupRealtimeListeners = () => {
            if (!isAuthReady) return;

            const { onSnapshot, collection } = window.firebase;

            // --- Materials ç›£è½ ---
            const materialsRef = collection(db, getCollectionPath('materials'));
            onSnapshot(materialsRef, (snapshot) => {
                const newMaterials = {};
                snapshot.forEach(doc => {
                    // ç¢ºä¿ ID ä¾†è‡ª document ID
                    newMaterials[doc.id] = { id: doc.id, ...doc.data() };
                });
                // æ›´æ–°å…¨åŸŸè®Šæ•¸ä¸¦æ¸²æŸ“ UI
                materials = newMaterials;
                console.log("åŸç‰©æ–™è³‡æ–™å·²å¾ Firestore å³æ™‚æ›´æ–°:", Object.keys(materials).length);
                
                let materialArray = Object.values(materials);
                materialArray.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));
                renderMaterialList(materialArray);
                updateRecipeIngredientsForm(); // æ›´æ–°é£Ÿè­œç·¨è¼¯å€çš„ææ–™é¸é …
                calculateCurrentRecipeCost(); // é‡æ–°è¨ˆç®—ç•¶å‰é£Ÿè­œæˆæœ¬
            }, (error) => {
                console.error("åŸç‰©æ–™å³æ™‚ç›£è½å¤±æ•—:", error);
            });

            // --- Recipes ç›£è½ ---
            const recipesRef = collection(db, getCollectionPath('recipes'));
            onSnapshot(recipesRef, (snapshot) => {
                const newRecipes = [];
                snapshot.forEach(doc => {
                    // ç¢ºä¿ ID ä¾†è‡ª document ID
                    newRecipes.push({ id: doc.id, ...doc.data() });
                });
                // æ›´æ–°å…¨åŸŸè®Šæ•¸ä¸¦æ¸²æŸ“ UI
                recipes = newRecipes;
                console.log("é£Ÿè­œè³‡æ–™å·²å¾ Firestore å³æ™‚æ›´æ–°:", recipes.length);
                recipes.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));
                renderRecipeList(recipes);
            }, (error) => {
                console.error("é£Ÿè­œå³æ™‚ç›£è½å¤±æ•—:", error);
            });
        };

        // 3. Firestore å¯«å…¥æ“ä½œ
        const addOrUpdateMaterialFirestore = async (materialData, id) => {
            if (!isAuthReady) return console.error("Firebase å°šæœªèªè­‰å®Œæˆï¼Œç„¡æ³•å¯«å…¥ã€‚");
            const { doc, setDoc } = window.firebase;
            const docId = id || generateId();
            const docRef = doc(db, getCollectionPath('materials'), docId);
            
            // å¯«å…¥è³‡æ–™ï¼Œå°‡ ID å„²å­˜ç‚ºæ–‡ä»¶ ID
            await setDoc(docRef, materialData);
        };

        const deleteMaterialFirestore = async (id) => {
            if (!isAuthReady) return console.error("Firebase å°šæœªèªè­‰å®Œæˆï¼Œç„¡æ³•åˆªé™¤ã€‚");
            const { doc, deleteDoc } = window.firebase;
            const docRef = doc(db, getCollectionPath('materials'), id);
            await deleteDoc(docRef);
        };

        const addOrUpdateRecipeFirestore = async (recipeData, id) => {
            if (!isAuthReady) return console.error("Firebase å°šæœªèªè­‰å®Œæˆï¼Œç„¡æ³•å¯«å…¥ã€‚");
            const { doc, setDoc, addDoc, collection } = window.firebase;
            
            if (id) {
                // æ›´æ–°ç¾æœ‰æ–‡ä»¶
                const docRef = doc(db, getCollectionPath('recipes'), id);
                await setDoc(docRef, recipeData);
            } else {
                // æ–°å¢æ–‡ä»¶
                const recipesRef = collection(db, getCollectionPath('recipes'));
                await addDoc(recipesRef, recipeData);
            }
        };

        const deleteRecipeFirestore = async (id) => {
            if (!isAuthReady) return console.error("Firebase å°šæœªèªè­‰å®Œæˆï¼Œç„¡æ³•åˆªé™¤ã€‚");
            const { doc, deleteDoc } = window.firebase;
            const docRef = doc(db, getCollectionPath('recipes'), id);
            await deleteDoc(docRef);
        };
        
        // --- åŸç‰©æ–™ (Raw Materials) é‚è¼¯ (ä½¿ç”¨ Firestore å¯«å…¥) ---
        
        // è¨ˆç®—å¾—ç‡å–®åƒ¹
        const calculateYieldCost = (purchasePrice, specification, yieldPercentage) => {
            if (isNaN(purchasePrice) || purchasePrice <= 0 || isNaN(specification) || specification <= 0 || isNaN(yieldPercentage) || yieldPercentage <= 0) {
                return 0;
            }
            // å…¬å¼: (é€²åƒ¹ / è¦æ ¼) / (å¾—ç‡ / 100)
            return (purchasePrice / specification) / (yieldPercentage / 100);
        };
        
        /**
         * å„²å­˜åŸç‰©æ–™åˆ° Firestoreï¼Œä¸¦è§¸ç™¼ UI é€é onSnapshot æ›´æ–°
         * @param {object} materialData - å–®å€‹ç‰©æ–™è³‡æ–™
         * @param {string} id - æ–‡ä»¶ ID
         */
        const handleMaterialSubmit = async (e) => {
            e.preventDefault();

            const id = document.getElementById('material-id').value;
            const name = document.getElementById('material-name').value;
            const supplier = document.getElementById('material-supplier').value;
            const purchasePrice = parseFloat(document.getElementById('material-price').value);
            const specification = parseFloat(document.getElementById('material-spec').value);
            const costUnit = document.getElementById('material-cost-unit').value;
            const yieldPercentage = parseFloat(document.getElementById('material-yield').value);

            const yieldCostPerUnit = calculateYieldCost(purchasePrice, specification, yieldPercentage);

            if (!name || isNaN(purchasePrice) || purchasePrice <= 0 || isNaN(specification) || specification <= 0 || !costUnit || isNaN(yieldPercentage) || yieldPercentage <= 0) {
                console.error("è¼¸å…¥è³‡æ–™ç„¡æ•ˆï¼Œè«‹æª¢æŸ¥æ‰€æœ‰å¿…å¡«æ¬„ä½ã€‚");
                return;
            }
            if (yieldCostPerUnit === 0) {
                 console.error("è¨ˆç®—å¾—ç‡å–®åƒ¹å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¼¸å…¥çš„åƒ¹æ ¼ã€è¦æ ¼æˆ–å¾—ç‡æ˜¯å¦ç‚º 0ã€‚");
                 return;
            }

            const materialData = { name, supplier, purchasePrice, specification, costUnit, yieldPercentage, yieldCostPerUnit };
            
            try {
                await addOrUpdateMaterialFirestore(materialData, id);
                resetMaterialForm();
            } catch (error) {
                console.error("å„²å­˜åŸç‰©æ–™åˆ° Firestore å¤±æ•—:", error);
            }
        };

        const editMaterial = (id) => {
            const material = materials[id];
            if (!material) return;
            
            document.getElementById('material-id').value = id;
            document.getElementById('material-name').value = material.name;
            document.getElementById('material-supplier').value = material.supplier || '';
            document.getElementById('material-price').value = material.purchasePrice;
            document.getElementById('material-spec').value = material.specification;
            document.getElementById('material-cost-unit').value = material.costUnit;
            document.getElementById('material-yield').value = material.yieldPercentage;
            
            updateCalculatedCostDisplay(); // æ›´æ–°é¡¯ç¤º
            
            document.getElementById('material-submit-btn').innerHTML = '<i data-lucide="save" class="w-5 h-5 inline-block mr-2"></i> æ›´æ–°åŸç‰©æ–™';
            document.getElementById('material-submit-btn').classList.remove('btn-primary');
            document.getElementById('material-submit-btn').classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white');
            lucide.createIcons();
            
            // æ²å‹•åˆ°è¡¨å–®
            document.getElementById('material-form').scrollIntoView({ behavior: 'smooth' });
        };

        const deleteMaterial = async (id) => {
            if (!confirmAction("ç¢ºå®šè¦åˆªé™¤æ­¤åŸç‰©æ–™å—? æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) return; 

            try {
                await deleteMaterialFirestore(id);
                resetMaterialForm(); // åˆªé™¤æˆåŠŸå¾Œé‡è¨­è¡¨å–®
            } catch (error) {
                console.error("åˆªé™¤åŸç‰©æ–™å¤±æ•—:", error);
            }
        };

        const renderMaterialList = (materialArray) => {
            // ... (æ­¤å‡½æ•¸é‚è¼¯ä¸è®Šï¼Œåƒ…ä½¿ç”¨ materials å…¨åŸŸè®Šæ•¸)
            const listEl = document.getElementById('material-list');
            listEl.innerHTML = '';
            
            if (materialArray.length === 0) {
                listEl.innerHTML = '<p class="text-center py-6" style="color: var(--color-text-medium);">ç›®å‰æ²’æœ‰åŸç‰©æ–™ã€‚è«‹æ–°å¢ã€‚</p>';
                return;
            }

            materialArray.forEach(m => {
                const supplierText = m.supplier ? `<span class="text-xs block" style="color: var(--color-text-medium);">ä¾›è²¨å•†: ${m.supplier}</span>` : '';
                const costUnitName = getUnitName(m.costUnit);
                
                const itemEl = document.createElement('div');
                itemEl.className = 'flex flex-col md:grid md:grid-cols-12 items-center gap-3 p-4 rounded-lg transition duration-150 shadow-md hover:shadow-xl';
                itemEl.style.backgroundColor = '#262626'; /* æ·±è‰²å¡ç‰‡èƒŒæ™¯ */
                itemEl.style.border = '1px solid #3f3f46'; /* é‚Šæ¡† */
                itemEl.innerHTML = `
                    <!-- 1. åç¨±èˆ‡ä¾›æ‡‰å•† -->
                    <div class="md:col-span-4 w-full">
                        <p class="font-bold text-lg text-white">${m.name}</p>
                        ${supplierText}
                    </div>
                    
                    <!-- 2. æ¡è³¼è³‡è¨Š (æ‰‹æ©Ÿä¸Šå †ç–Š) -->
                    <div class="md:col-span-4 w-full grid grid-cols-2 text-sm gap-x-4" style="color: var(--color-text-light);">
                        <p class="truncate">åƒ¹æ ¼: <span class="font-semibold">${m.purchasePrice.toFixed(2)} å…ƒ</span></p>
                        <p class="truncate">å¾—ç‡: <span class="font-semibold">${m.yieldPercentage.toFixed(1)}%</span></p>
                        <p class="truncate">è¦æ ¼: <span class="font-semibold">${m.specification} ${costUnitName}</span></p>
                    </div>

                    <!-- 3. å¾—ç‡å–®åƒ¹ (æœ€é‡è¦) -->
                    <div class="md:col-span-3 w-full text-right p-2 rounded-lg border" style="background-color: #3f3f46; border-color: var(--color-gold-accent);">
                        <p class="text-sm font-medium" style="color: var(--color-text-medium);">å–®åƒ¹ (å…ƒ / ${costUnitName})</p>
                        <p class="text-xl font-extrabold" style="color: var(--color-gold-accent);">${m.yieldCostPerUnit.toFixed(4)}</p>
                    </div>

                    <!-- 4. æ“ä½œæŒ‰éˆ• (ä½¿ç”¨ Icon) -->
                    <div class="md:col-span-1 flex space-x-2 w-full justify-end">
                        <button data-id="${m.id}" data-action="edit" class="edit-material-btn text-yellow-400 hover:text-yellow-600 p-2 rounded-full hover:bg-gray-700 transition" title="ç·¨è¼¯">
                            <i data-lucide="pencil" class="w-5 h-5"></i>
                        </button>
                        <button data-id="${m.id}" data-action="delete" class="delete-material-btn text-red-400 hover:text-red-600 p-2 rounded-full hover:bg-gray-700 transition" title="åˆªé™¤">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
                listEl.appendChild(itemEl);
                // é‡æ–°åˆå§‹åŒ– Lucide åœ–æ¨™ï¼Œå› ç‚ºæ˜¯å‹•æ…‹æ’å…¥çš„
                lucide.createIcons();
            });
        };

        const updateCalculatedCostDisplay = () => {
            const price = parseFloat(document.getElementById('material-price').value);
            const spec = parseFloat(document.getElementById('material-spec').value);
            const yieldPerc = parseFloat(document.getElementById('material-yield').value);
            const costUnit = document.getElementById('material-cost-unit').value;
            
            const calculatedCost = calculateYieldCost(price, spec, yieldPerc);
            
            document.getElementById('calculated-yield-cost').textContent = calculatedCost.toFixed(4);
            document.getElementById('calculated-cost-unit').textContent = getUnitName(costUnit) || 'å–®ä½'; // é¡¯ç¤ºæœ€å°å–®ä½åç¨±
        };

        const resetMaterialForm = () => {
            document.getElementById('material-form').reset();
            document.getElementById('material-id').value = '';
            document.getElementById('calculated-yield-cost').textContent = '0.0000';
            document.getElementById('calculated-cost-unit').textContent = 'å–®ä½';
            document.getElementById('material-submit-btn').innerHTML = '<i data-lucide="plus" class="w-5 h-5 inline-block mr-2"></i> æ–°å¢åŸç‰©æ–™';
            document.getElementById('material-submit-btn').classList.remove('bg-blue-600', 'hover:bg-blue-700', 'text-white');
            document.getElementById('material-submit-btn').classList.add('btn-primary');
            lucide.createIcons();
        };
        
        // --- é£Ÿè­œ (Recipes) é‚è¼¯ (ä½¿ç”¨ Firestore å¯«å…¥) ---
        
        // è¨ˆç®—å»ºè­°å”®åƒ¹
        const calculateSellingPrice = (totalCost, targetMarginPercentage) => {
            // ç¢ºä¿ç›®æ¨™æ¯›åˆ©ç‡ç‚ºæœ‰æ•ˆæ•¸å­—ï¼Œä¸”åœ¨ [0, 100) å€é–“
            if (isNaN(totalCost) || totalCost < 0 || isNaN(targetMarginPercentage) || targetMarginPercentage >= 100 || targetMarginPercentage < 0) {
                 if (targetMarginPercentage >= 100) return 0; // 100% æ¯›åˆ©æ™‚ç„¡æ³•è¨ˆç®—
                return 0;
            }
            const marginRate = targetMarginPercentage / 100;
            // å»ºè­°å”®åƒ¹ = ç¸½æˆæœ¬ / (1 - æ¯›åˆ©ç‡)
            return totalCost / (1 - marginRate);
        };


        // é€™è£¡ä½¿ç”¨ yieldCostPerUnit (å¾—ç‡å–®åƒ¹)
        const calculateIngredientCost = (materialId, quantity, recipeUnit) => {
            const material = materials[materialId];
            if (!material || isNaN(quantity) || quantity <= 0) return 0;

            const costUnit = material.costUnit; // æœ€å°è¨ˆç®—å–®ä½ (g, ml, unit)
            const yieldCostPerUnit = material.yieldCostPerUnit; // å¾—ç‡å–®åƒ¹

            let multiplier = 0; 
            
            // å°‹æ‰¾ costUnit å±¬æ–¼å“ªå€‹ç¾¤çµ„
            const costUnitGroupName = Object.keys(UNIT_GROUPS).find(groupName => 
                Object.keys(UNIT_GROUPS[groupName]).includes(costUnit)
            );
            
            // å°‹æ‰¾ recipeUnit å±¬æ–¼å“ªå€‹ç¾¤çµ„
            const recipeUnitGroupName = Object.keys(UNIT_GROUPS).find(groupName => 
                Object.keys(UNIT_GROUPS[groupName]).includes(recipeUnit)
            );

            // ç¢ºä¿å…©å–®ä½å±¬æ–¼åŒä¸€ç¾¤çµ„
            if (costUnitGroupName && recipeUnitGroupName && costUnitGroupName === recipeUnitGroupName) {
                const group = UNIT_GROUPS[costUnitGroupName];
                
                // å–®ä½æ›ç®—å› å­ (å°‡ recipeQuantity æ›ç®—æˆ costUnit æ•¸é‡)
                // factor = (recipeUnit å°åŸºæº–å–®ä½çš„ä¹˜æ•¸) / (costUnit å°åŸºæº–å–®ä½çš„ä¹˜æ•¸)
                multiplier = group[recipeUnit] / group[costUnit];
                
            } else if (costUnit === recipeUnit) {
                multiplier = 1; // å–®ä½ç›¸åŒï¼Œä¹˜æ•¸ç‚º 1
            } else {
                 // å–®ä½ä¸ä¸€è‡´ä¸”æ²’æœ‰æ˜ç¢ºçš„æ›ç®—æˆ–ä¸åŒçµ„
                return 0;
            }

            // ç¸½æˆæœ¬ = æ•¸é‡ * æ›ç®—å› å­ * å¾—ç‡å–®åƒ¹
            return quantity * multiplier * yieldCostPerUnit;
        };

        const calculateRecipeTotalCost = (ingredients) => {
            let totalCost = 0;
            if (ingredients && Array.isArray(ingredients)) {
                ingredients.forEach(ing => {
                    totalCost += calculateIngredientCost(ing.materialId, ing.quantity, ing.recipeUnit);
                });
            }
            return totalCost;
        };
        
        // å³æ™‚è¨ˆç®—ç•¶å‰ç·¨è¼¯é£Ÿè­œçš„æˆæœ¬ã€æ¯›åˆ©ç‡å’Œå”®åƒ¹
        window.calculateCurrentRecipeCost = () => {
            const ingredientInputs = document.querySelectorAll('.ingredient-input-group');
            const currentIngredients = [];
            ingredientInputs.forEach(group => {
                const materialId = group.querySelector('.ingredient-material-id').value;
                const quantity = parseFloat(group.querySelector('.ingredient-quantity').value);
                const recipeUnit = group.querySelector('.ingredient-unit').value;
                if (materialId && !isNaN(quantity) && quantity > 0 && recipeUnit) {
                    currentIngredients.push({ materialId, quantity, recipeUnit });
                }
            });

            const totalCost = calculateRecipeTotalCost(currentIngredients);
            
            const targetMarginInput = document.getElementById('recipe-target-margin');
            let targetMargin = parseInt(targetMarginInput.value, 10) || 0;
            
            // ç¢ºä¿æ¯›åˆ©ç‡åœ¨ [0, 100] ä¹‹é–“
            targetMargin = Math.max(0, Math.min(100, targetMargin));
            // æ›´æ–°è¼¸å…¥æ¡†çš„å€¼ï¼Œç¢ºä¿å®ƒæ˜¯æ•´æ•¸
            targetMarginInput.value = targetMargin;

            const sellingPrice = calculateSellingPrice(totalCost, targetMargin);

            document.getElementById('calculated-cost').textContent = `${totalCost.toFixed(2)}`;
            document.getElementById('calculated-selling-price').textContent = sellingPrice.toFixed(2);
        };

        const renderRecipeList = (recipeArray) => {
            const listEl = document.getElementById('recipe-list');
            listEl.innerHTML = '';
            
            if (recipeArray.length === 0) {
                listEl.innerHTML = '<p class="text-center py-6" style="color: var(--color-text-medium);">ç›®å‰æ²’æœ‰é£Ÿè­œã€‚è«‹æ–°å¢ã€‚</p>';
                return;
            }

            recipeArray.forEach(r => {
                const totalCost = calculateRecipeTotalCost(r.ingredients);
                const targetMargin = r.targetMargin || 50; // ä½¿ç”¨å„²å­˜çš„æ¯›åˆ©ç‡ï¼Œé è¨­ 50%
                const sellingPrice = calculateSellingPrice(totalCost, targetMargin);

                const itemEl = document.createElement('div');
                itemEl.className = 'p-4 rounded-lg transition duration-150 shadow-md';
                itemEl.style.backgroundColor = '#262626'; /* æ·±è‰²å¡ç‰‡èƒŒæ™¯ */
                itemEl.style.border = '1px solid #3f3f46'; /* é‚Šæ¡† */
                itemEl.innerHTML = `
                    <div class="flex justify-between items-start mb-3 border-b pb-2" style="border-color: #3f3f46;">
                        <p class="text-xl font-bold" style="color: var(--color-gold-accent);">${r.name}</p>
                        <div class="text-right">
                            <p class="text-xs" style="color: var(--color-text-medium);">ç›®æ¨™æ¯›åˆ©ç‡:</p>
                            <span class="text-xl font-extrabold text-red-400">${targetMargin.toFixed(0)}%</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div class="data-display-box p-3 rounded-lg">
                            <span class="text-sm" style="color: var(--color-text-medium);">ç¸½æˆæœ¬:</span>
                            <p class="text-xl font-bold text-green-400">${totalCost.toFixed(2)} å…ƒ</p>
                        </div>
                        <div class="data-display-box p-3 rounded-lg">
                            <span class="text-sm" style="color: var(--color-text-medium);">å»ºè­°å”®åƒ¹:</span>
                            <p class="text-xl font-bold" style="color: var(--color-gold-accent);">${sellingPrice.toFixed(2)} å…ƒ</p>
                        </div>
                    </div>
                    
                    <!-- é£Ÿææ˜ç´° (æ‰‹æ©Ÿä¸Šè¼ƒç‚ºç·Šæ¹Š) -->
                    <div class="text-sm mt-4 border-t pt-3 space-y-1" style="border-color: #3f3f46; color: var(--color-text-light);">
                        <p class="font-semibold text-white">é£Ÿææ˜ç´°:</p>
                        ${r.ingredients.map(ing => {
                            const material = materials[ing.materialId];
                            if (!material) return `<span class="text-red-400">æ‰¾ä¸åˆ°ç‰©æ–™ (ID: ${ing.materialId})</span>`;
                            const cost = calculateIngredientCost(ing.materialId, ing.quantity, ing.recipeUnit);
                            const unitName = getUnitName(ing.recipeUnit);
                            return `
                                <div class="flex justify-between text-xs md:text-sm">
                                    <span class="text-gray-300">${material.name} (${ing.quantity} ${unitName})</span>
                                    <span class="font-medium text-green-400">${cost.toFixed(2)} å…ƒ</span>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <div class="flex justify-end space-x-2 mt-4 border-t pt-3" style="border-color: #3f3f46;">
                        <button data-id="${r.id}" data-action="edit" class="edit-recipe-btn text-yellow-400 hover:text-yellow-600 p-2 rounded-full hover:bg-gray-700 transition" title="ç·¨è¼¯">
                            <i data-lucide="pencil" class="w-5 h-5"></i>
                        </button>
                        <button data-id="${r.id}" data-action="delete" class="delete-recipe-btn text-red-400 hover:text-red-600 p-2 rounded-full hover:bg-gray-700 transition" title="åˆªé™¤">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
                listEl.appendChild(itemEl);
                lucide.createIcons();
            });
        };
        
        const handleRecipeSubmit = async (e) => {
            e.preventDefault();
            if (!isAuthReady) return; // ç¢ºä¿èªè­‰å®Œæˆ

            const id = document.getElementById('recipe-doc-id').value;
            const name = document.getElementById('recipe-name').value.trim();
            
            // ç²å–ä¸¦ç¢ºä¿ç›®æ¨™æ¯›åˆ©ç‡ç‚ºæ•´æ•¸ [0, 100]
            let targetMargin = parseInt(document.getElementById('recipe-target-margin').value, 10) || 0;
            targetMargin = Math.max(0, Math.min(100, targetMargin));

            const ingredientInputs = document.querySelectorAll('.ingredient-input-group');
            
            if (!name) {
                console.error("é£Ÿè­œåç¨±ä¸èƒ½ç‚ºç©º");
                return;
            }

            const ingredients = [];
            ingredientInputs.forEach(group => {
                const materialId = group.querySelector('.ingredient-material-id').value;
                const quantity = parseFloat(group.querySelector('.ingredient-quantity').value);
                const recipeUnit = group.querySelector('.ingredient-unit').value;
                
                // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„æ•¸é‡å’Œå–®ä½ï¼Œå³ä½¿æˆæœ¬ç‚º 0 ä¹Ÿå…è¨±å„²å­˜
                if (materialId && !isNaN(quantity) && quantity > 0 && recipeUnit) {
                    ingredients.push({ materialId, quantity, recipeUnit });
                }
            });

            if (ingredients.length === 0) {
                 console.error("é£Ÿè­œè‡³å°‘éœ€è¦ä¸€å€‹é£Ÿæ");
                return;
            }

            const recipeData = { name, ingredients, targetMargin }; // æ–°å¢ targetMargin

            try {
                await addOrUpdateRecipeFirestore(recipeData, id);
                console.log("é£Ÿè­œå„²å­˜æˆåŠŸ:", id || 'æ–°æ–‡ä»¶');
                resetRecipeForm();
            } catch (error) {
                console.error("å„²å­˜é£Ÿè­œå¤±æ•—:", error);
            }
        };

        const editRecipe = (id) => {
            const recipe = recipes.find(r => r.id === id);
            if (!recipe) return;

            document.getElementById('recipe-doc-id').value = id;
            document.getElementById('recipe-name').value = recipe.name;
            document.getElementById('recipe-target-margin').value = recipe.targetMargin || 50; // è¼‰å…¥ç›®æ¨™æ¯›åˆ©ç‡
            document.getElementById('recipe-submit-btn').innerHTML = '<i data-lucide="save" class="w-5 h-5 inline-block mr-1"></i> æ›´æ–°é£Ÿè­œ';
            document.getElementById('recipe-submit-btn').classList.remove('btn-primary');
            document.getElementById('recipe-submit-btn').classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white');
            lucide.createIcons();

            // è¼‰å…¥é£Ÿæ
            const container = document.getElementById('ingredient-input-container');
            container.innerHTML = '';
            recipe.ingredients.forEach(ing => addIngredientInput(ing));
            calculateCurrentRecipeCost();

            // åˆ‡æ›åˆ°é£Ÿè­œåˆ†é ä¸¦æ²å‹•åˆ°è¡¨å–®
            switchTab('recipes');
            document.getElementById('recipe-calculator').scrollIntoView({ behavior: 'smooth' });
        };

        const deleteRecipe = async (id) => {
            if (!confirmAction("ç¢ºå®šè¦åˆªé™¤æ­¤é£Ÿè­œå—?")) return;

            try {
                await deleteRecipeFirestore(id);
                console.log("é£Ÿè­œåˆªé™¤æˆåŠŸ:", id);
                resetRecipeForm();
            } catch (error) {
                console.error("åˆªé™¤é£Ÿè­œå¤±æ•—:", error);
            }
        };

        const resetRecipeForm = () => {
            document.getElementById('recipe-form').reset();
            document.getElementById('recipe-doc-id').value = '';
            document.getElementById('recipe-submit-btn').innerHTML = '<i data-lucide="save" class="w-5 h-5 inline-block mr-1"></i> å„²å­˜é£Ÿè­œ';
            document.getElementById('recipe-submit-btn').classList.remove('bg-blue-600', 'hover:bg-blue-700', 'text-white');
            document.getElementById('recipe-submit-btn').classList.add('btn-primary');
            lucide.createIcons();

            // é‡è¨­æˆæœ¬é¡¯ç¤º
            document.getElementById('calculated-cost').textContent = '0.00';
            document.getElementById('calculated-selling-price').textContent = '0.00';
            
            // é‡è¨­é£Ÿæè¼¸å…¥æ¬„ä½
            const container = document.getElementById('ingredient-input-container');
            container.innerHTML = '<p class="text-sm italic text-center py-2" style="color: var(--color-text-medium);">è«‹åœ¨ä¸‹æ–¹æ–°å¢é£Ÿæã€‚</p>';
        };


        // --- é£Ÿæè¼¸å…¥æ¬„ä½å‹•æ…‹ç”Ÿæˆ ---
        const addIngredientInput = (initialData = {}) => {
            const container = document.getElementById('ingredient-input-container');
            if (container.querySelector('p.text-sm')) {
                container.innerHTML = ''; // ç§»é™¤æç¤ºæ–‡å­—
            }

            const materialOptions = Object.values(materials).map(m => `
                <option value="${m.id}" ${initialData.materialId === m.id ? 'selected' : ''} class="bg-gray-700 text-white">
                    ${m.name} (${m.costUnit} - ${m.yieldCostPerUnit.toFixed(4)}å…ƒ)
                </option>
            `).join('');

            // è¼”åŠ©å‡½å¼ï¼šæ ¹æ“šææ–™ ID ç”¢ç”Ÿå–®ä½é¸é …
            const getUnitOptions = (selectedMaterialId, currentUnit) => {
                const material = materials[selectedMaterialId];
                if (!material) {
                    return `<option value="" disabled selected class="bg-gray-700 text-white">é¸æ“‡å–®ä½</option>`;
                }
                const costUnit = material.costUnit;
                
                // æ‰¾å‡º costUnit æ‰€åœ¨çš„åˆ†çµ„ (ä¾‹å¦‚ 'g' å±¬æ–¼ UNIT_GROUPS['g'])
                const groupName = Object.keys(UNIT_GROUPS).find(base => 
                    Object.keys(UNIT_GROUPS[base]).includes(costUnit)
                );

                let units = [costUnit]; // Default to only the cost unit
                if (groupName) {
                    units = Object.keys(UNIT_GROUPS[groupName]); // Use all units in that group
                }

                // å¦‚æœæ²’æœ‰è¨­å®šç•¶å‰å–®ä½ï¼Œå‰‡é è¨­é¸ä¸­æœ€å°çš„è¨ˆç®—å–®ä½
                if (!currentUnit && material) {
                    currentUnit = costUnit;
                }
                
                // ç¢ºä¿ç•¶å‰å–®ä½æ˜¯æœ‰æ•ˆçš„ï¼Œå¦‚æœç„¡æ•ˆå‰‡é è¨­ç‚º costUnit
                if (!units.includes(currentUnit) && material) {
                     currentUnit = costUnit;
                }

                return units.map(u => `
                    <option value="${u}" ${currentUnit === u ? 'selected' : ''} class="bg-gray-700 text-white">${getUnitName(u)} (${u})</option>
                `).join('');
            };

            const inputGroup = document.createElement('div');
            // Mobile: grid-cols-4 ç¢ºä¿åœ¨å°è¢å¹•ä¸Šç·Šæ¹Šï¼ŒDesktop: grid-cols-12
            inputGroup.className = 'ingredient-input-group grid grid-cols-12 gap-2 items-center p-2 rounded-lg';
            inputGroup.style.backgroundColor = '#3f3f46'; /* Slate 700 */
            inputGroup.style.border = '1px solid #52525B';

            // é å…ˆç”Ÿæˆå–®ä½é¸é …
            let initialUnitOptions = getUnitOptions(initialData.materialId, initialData.recipeUnit);

            inputGroup.innerHTML = `
                <!-- ææ–™é¸æ“‡ (æ‰‹æ©Ÿä½” 6 æ¬„) -->
                <select class="ingredient-material-id col-span-12 sm:col-span-6 p-2 rounded-md text-sm" required>
                    <option value="" disabled ${!initialData.materialId ? 'selected' : ''} class="bg-gray-700 text-white">é¸æ“‡ææ–™ (å¿…é¸)</option>
                    ${materialOptions}
                </select>
                
                <!-- æ•¸é‡ (æ‰‹æ©Ÿä½” 3 æ¬„) -->
                <input type="number" step="0.01" min="0.01" placeholder="æ•¸é‡" value="${initialData.quantity || ''}" required class="ingredient-quantity col-span-4 sm:col-span-2 p-2 rounded-md text-sm text-right">
                
                <!-- å–®ä½ (æ‰‹æ©Ÿä½” 3 æ¬„) -->
                <select class="ingredient-unit col-span-4 sm:col-span-3 p-2 rounded-md text-sm" required>
                    ${initialUnitOptions}
                </select>
                
                <!-- ç§»é™¤æŒ‰éˆ• (æ‰‹æ©Ÿä½” 2 æ¬„) -->
                <button type="button" class="remove-ingredient-btn col-span-4 sm:col-span-1 text-red-400 hover:text-red-600 p-1 transition" title="ç§»é™¤">
                    <i data-lucide="minus-circle" class="w-5 h-5 mx-auto"></i>
                </button>
            `;

            // å–®ä½è®Šå‹•ç›£è½å™¨
            const materialSelect = inputGroup.querySelector('.ingredient-material-id');
            const unitSelect = inputGroup.querySelector('.ingredient-unit');
            
            materialSelect.addEventListener('change', (e) => {
                const selectedId = e.target.value;
                const selectedMaterial = materials[selectedId];
                
                // æ›´æ–°å–®ä½ä¸‹æ‹‰é¸å–®ï¼Œä¸¦é è¨­é¸æ“‡æˆæœ¬å–®ä½
                unitSelect.innerHTML = getUnitOptions(selectedId, selectedMaterial ? selectedMaterial.costUnit : '');
                
                calculateCurrentRecipeCost();
            });

            // ç§»é™¤æŒ‰éˆ•ç›£è½å™¨
            inputGroup.querySelector('.remove-ingredient-btn').addEventListener('click', () => {
                inputGroup.remove();
                calculateCurrentRecipeCost();
                if (container.children.length === 0) {
                     container.innerHTML = '<p class="text-sm italic text-center py-2" style="color: var(--color-text-medium);">è«‹åœ¨ä¸‹æ–¹æ–°å¢é£Ÿæã€‚</p>';
                }
            });

            // æ•¸é‡/å–®ä½è®Šå‹•æ™‚é‡æ–°è¨ˆç®—æˆæœ¬
            inputGroup.querySelector('.ingredient-quantity').addEventListener('input', calculateCurrentRecipeCost);
            unitSelect.addEventListener('change', calculateCurrentRecipeCost);
            
            container.appendChild(inputGroup);
            lucide.createIcons();
        };

        const updateRecipeIngredientsForm = () => {
            // é‡æ–°æ¸²æŸ“ç•¶å‰æ‰€æœ‰é£Ÿæè¼¸å…¥æ¬„ä½ä»¥æ›´æ–° Material Select options
            const ingredientGroups = document.querySelectorAll('.ingredient-input-group');
            const currentInputs = [];
            ingredientGroups.forEach(group => {
                currentInputs.push({
                    materialId: group.querySelector('.ingredient-material-id').value,
                    quantity: group.querySelector('.ingredient-quantity').value,
                    recipeUnit: group.querySelector('.ingredient-unit').value
                });
            });

            const container = document.getElementById('ingredient-input-container');
            const hasPlaceholder = container.querySelector('p.text-sm');
            container.innerHTML = '';
            currentInputs.forEach(ing => addIngredientInput(ing));
            if (currentInputs.length === 0 && hasPlaceholder) {
                 container.innerHTML = '<p class="text-sm italic text-center py-2" style="color: var(--color-text-medium);">è«‹åœ¨ä¸‹æ–¹æ–°å¢é£Ÿæã€‚</p>';
            }
            calculateCurrentRecipeCost();
        };


        const switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        };

        const confirmAction = (message) => {
            // ç”±æ–¼ä¸èƒ½ä½¿ç”¨ window.confirmï¼Œé€™è£¡åªè¼¸å‡ºè¨Šæ¯åˆ° console
            console.warn("ç¢ºèªæ“ä½œ (è«‹åœ¨æ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä¸­è¨­è¨ˆ Modal): " + message);
            // ç”±æ–¼æ˜¯è™›æ“¬ç’°å¢ƒï¼Œæˆ‘å€‘å‡è¨­ç¢ºèªé€šé
            return true; 
        };


        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            // PWA: æ³¨å…¥ Manifest ç›¸é—œé‚è¼¯æ‡‰åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­è™•ç†ã€‚

            // åˆ†é åˆ‡æ›ç›£è½
            document.getElementById('tab-materials').addEventListener('click', () => switchTab('materials'));
            document.getElementById('tab-recipes').addEventListener('click', () => switchTab('recipes'));

            // åŸç‰©æ–™äº‹ä»¶ç›£è½
            document.getElementById('material-form').addEventListener('submit', handleMaterialSubmit);
            document.getElementById('material-list-container').addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = btn.getAttribute('data-id');
                const action = btn.getAttribute('data-action');
                if (action === 'edit') editMaterial(id);
                if (action === 'delete') deleteMaterial(id);
            });
            
            // åŸç‰©æ–™è¡¨å–®è¼¸å…¥è®Šå‹•æ™‚ï¼Œæ›´æ–°è¨ˆç®—å‡ºçš„æˆæœ¬
            document.getElementById('material-price').addEventListener('input', updateCalculatedCostDisplay);
            document.getElementById('material-spec').addEventListener('input', updateCalculatedCostDisplay);
            document.getElementById('material-cost-unit').addEventListener('change', updateCalculatedCostDisplay);
            document.getElementById('material-yield').addEventListener('input', updateCalculatedCostDisplay);


            // é£Ÿè­œäº‹ä»¶ç›£è½
            document.getElementById('recipe-form').addEventListener('submit', handleRecipeSubmit);
            document.getElementById('add-ingredient-btn').addEventListener('click', () => addIngredientInput());
            document.getElementById('cancel-recipe-edit-btn').addEventListener('click', resetRecipeForm);
            
            document.getElementById('recipe-list-container').addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const id = btn.getAttribute('data-id');
                const action = btn.getAttribute('data-action');
                if (action === 'edit') editRecipe(id);
                if (action === 'delete') deleteRecipe(id);
            });

            // åˆå§‹åŒ–æ™‚åˆ‡æ›åˆ°ç¬¬ä¸€å€‹åˆ†é 
            switchTab('materials');
        });
    </script>
</body>
</html>